<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Riba Run – Cutscene, Map & Minigame</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #050711;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      height: 100%;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    #root {
      width: 100%;
      max-width: 1200px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0 auto;
    }

    .screen {
      flex: 1;
      display: none;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .screen.active {
      display: flex;
    }

    /* Cutscene screen */

    #cutscene-screen {
      background: #000;
      flex-direction: column;
    }

    #cutscene-wrapper {
      position: relative;
      width: 100%;
      max-width: 1200px;
      max-height: calc(100vh - 80px);
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
    }

    #cutscene-video {
      width: 100%;
      height: auto;
      max-height: 100%;
      background: #000;
    }

    #cutscene-bottom-bar {
      width: 100%;
      padding: 8px 16px;
      box-sizing: border-box;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      background: #020308;
      border-top: 1px solid #111827;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: #2563eb;
      color: #f9fafb;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    /* Map screen */

    #map-screen {
      padding: 32px;
      box-sizing: border-box;
      background: radial-gradient(circle at top, #0b1120, #020617);
    }

    #map-card {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 30px 80px rgba(0,0,0,0.9);
      background: #020617;
    }

    #map-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.15);
    }

    .map-node {
      position: absolute;
      width: 72px;
      height: 72px;
      border-radius: 999px;
      border: 2px solid rgba(56,189,248,0.8);
      box-shadow:
        0 0 0 2px rgba(15,118,210,0.7),
        0 0 22px rgba(59,130,246,0.95);
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0f172a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5f3ff;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .map-node:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow:
        0 0 0 2px rgba(59,130,246,1),
        0 0 32px rgba(56,189,248,1);
    }

    .map-node-label {
      position: absolute;
      top: 76px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.9);
      white-space: nowrap;
    }

    /* Rough positions matching your map */
    #node-castle   { left: 16%; top: 68%; }
    #node-forest   { left: 48%; top: 53%; }
    #node-cave     { left: 76%; top: 40%; }
    #node-market   { left: 64%; top: 75%; }

    /* Game screen */

    #game-screen {
      flex-direction: column;
      padding: 8px 0 12px;
      box-sizing: border-box;
      align-items: center;
      background: #050711;
    }

    #game-header {
      font-size: 14px;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    #game-canvas {
      border-radius: 10px;
      border: 2px solid #111827;
      background: #000;
      image-rendering: pixelated;
      box-shadow: 0 24px 60px rgba(0,0,0,0.9);
    }

    #hud-text {
      margin-top: 6px;
      text-align: center;
      font-size: 13px;
      color: #e5e7eb;
    }

    #hud-sub {
      margin-top: 3px;
      text-align: center;
      font-size: 11px;
      color: #9ca3af;
    }

    #footer-line {
      margin-top: 4px;
      text-align: center;
      font-size: 11px;
      color: #6b7280;
    }

    /* Game over overlay */

    #game-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      z-index: 20;
    }

    #game-overlay.active {
      display: flex;
    }

    #overlay-box {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 22px 26px 20px;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 20px 70px rgba(0,0,0,0.9);
    }

    #overlay-box h2 {
      margin: 0 0 10px;
      font-size: 22px;
    }

    #overlay-box p {
      margin: 4px 0;
      font-size: 14px;
      color: #e5e7eb;
    }

    .btn-danger {
      background: #dc2626;
      color: #fee2e2;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
    }

    .btn-secondary:hover {
      background: #020617;
    }

    #overlay-note {
      margin-top: 8px;
      font-size: 11px;
      color: #facc15;
    }

    /* Toast */

    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      border: 1px solid #1e293b;
      padding: 6px 12px;
      font-size: 12px;
      color: #e5e7eb;
      display: none;
      z-index: 25;
      box-shadow: 0 12px 40px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>
  <div id="root">

    <!-- CUTSCENE SCREEN -->
    <div id="cutscene-screen" class="screen active">
      <div id="cutscene-wrapper">
        <video id="cutscene-video" playsinline preload="auto" controls>
          <source src="cutscene.mp4" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
      </div>
      <div id="cutscene-bottom-bar">
        <span>If the video doesn’t start, press play or click “Skip”.</span>
        <button id="btn-skip-cutscene" class="btn btn-primary">
          Skip ►
        </button>
      </div>
    </div>

    <!-- MAP SCREEN -->
    <div id="map-screen" class="screen">
      <div id="map-card">
        <img id="map-image" src="fantasy-world-map.png" alt="World map" />

        <div id="node-castle" class="map-node" data-level="castle">
          <span>1</span>
          <div class="map-node-label">Castle Hub</div>
        </div>

        <div id="node-forest" class="map-node" data-level="forest">
          <span>2</span>
          <div class="map-node-label">Forest Trials</div>
        </div>

        <div id="node-cave" class="map-node" data-level="cave">
          <span>3</span>
          <div class="map-node-label">Riba Cave</div>
        </div>

        <div id="node-market" class="map-node" data-level="market">
          <span>4</span>
          <div class="map-node-label">Market Town</div>
        </div>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen">
      <div id="game-header">Level: <span id="level-name">Castle Hub</span></div>
      <canvas id="game-canvas" width="960" height="480"></canvas>
      <div id="hud-text"></div>
      <div id="hud-sub">
        <strong>Controls:</strong> Arrow Up/Down = change lane · S = Sadaqah · R = Restart · M = Back to Map
      </div>
      <div id="footer-line">
        Riba Run 2D · Kestrel vs Riba Monster · Halal coins (green), Riba coins (red), Kestrl Card (blue), Investment Gate (yellow)
      </div>
    </div>
  </div>

  <!-- OVERLAY & TOAST -->
  <div id="game-overlay">
    <div id="overlay-box">
      <h2 id="overlay-title">Bankruptcy</h2>
      <p id="overlay-text">
        Your balance hit £0. The Riba Monster is looming over you in the Tunnel of Wants…
      </p>
      <div style="margin-top: 12px;">
        <button id="btn-restart" class="btn btn-secondary" style="margin-right: 8px;">
          Accept Bankruptcy (Restart)
        </button>
        <button id="btn-loan" class="btn btn-danger">
          Take Riba Loan (+£1000)
        </button>
      </div>
      <div id="overlay-note">
        Taking the loan boosts your balance but chains you to debt & interest. One mistake in hard mode = permanent death.
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    /***************
     * SCREEN LOGIC
     **************/
    const screens = {
      cutscene: document.getElementById('cutscene-screen'),
      map: document.getElementById('map-screen'),
      game: document.getElementById('game-screen'),
    };

    function showScreen(name) {
      Object.values(screens).forEach(el => el.classList.remove('active'));
      screens[name].classList.add('active');
    }

    const cutsceneVideo = document.getElementById('cutscene-video');
    const skipButton = document.getElementById('btn-skip-cutscene');

    cutsceneVideo.addEventListener('ended', () => {
      showScreen('map');
    });

    skipButton.addEventListener('click', () => {
      showScreen('map');
    });

    /***************
     * MAP LOGIC
     **************/
    const levelNameSpan = document.getElementById('level-name');

    document.querySelectorAll('.map-node').forEach(node => {
      node.addEventListener('click', () => {
        const lvl = node.dataset.level;
        const label = node.querySelector('.map-node-label').textContent;
        levelNameSpan.textContent = label;
        startGame(lvl);
        showScreen('game');
      });
    });

    /***************
     * GAME LOGIC
     **************/
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    const hudText = document.getElementById('hud-text');
    const overlay = document.getElementById('game-overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const overlayText = document.getElementById('overlay-text');
    const btnRestart = document.getElementById('btn-restart');
    const btnLoan = document.getElementById('btn-loan');
    const toast = document.getElementById('toast');

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    // Lanes
    const LANES = 3;
    const laneYs = [HEIGHT * 0.25, HEIGHT * 0.5, HEIGHT * 0.75];

    // Player
    const PLAYER_X = WIDTH * 0.25;
    const PLAYER_W = 40;
    const PLAYER_H = 32;

    // Monster
    const MONSTER_W = 70;
    const MONSTER_H = 60;
    const MONSTER_MAX_DIST = 200;
    const MONSTER_MIN_DIST = 10;

    // Items
    const ITEM_W = 28;
    const ITEM_H = 24;

    // Speed
    const BASE_SPEED = 260;         // pixels/sec
    const SPEED_INC = 6;            // per minute approx

    // --- Money model: calmer & clearer ---
    const BALANCE_START = 400;
    const BASE_LIVING_COST_PER_SEC = 3;        // living costs
    const INTEREST_RATE_PER_YEAR = 0.15;       // 15% "annual", but we'll scale

    // We'll convert it to a per-second rate that feels okay:
    const INTEREST_RATE_PER_SEC = INTEREST_RATE_PER_YEAR / (60 * 5); // gentle but visible

    const GREEN_VALUE = 25;   // halal income
    const RED_VALUE = 60;     // riba quick money (debt too)

    const SADAQAH_COST = 60;
    const SADAQAH_DEBT_REDUCTION = 140;  // pay down more than you gave
    const SADAQAH_DURATION = 10;         // seconds of barakah

    const KESTRL_DURATION = 8;           // seconds of riba-free shield

    const INVEST_COST = 80;
    const INVEST_PAYOFF = 200;
    const INVEST_DELAY = 14;             // seconds later

    // Monster influence on distance
    const MONSTER_GREEN_PUSH = 12;
    const MONSTER_RED_PULL = 18;
    const MONSTER_BASE_PULL_PER_SEC = 4;
    const MONSTER_EXTRA_PULL_HARD = 10;

    let lastTime = 0;
    let running = false;
    let hardMode = false;
    let currentLevel = 'castle';

    const state = {
      lane: 1,
      balance: BALANCE_START,
      debt: 0,
      speed: BASE_SPEED,
      monsterDist: MONSTER_MAX_DIST * 0.6,
      items: [],
      investments: [],
      barakahActive: false,
      barakahTime: 0,
      kestrlActive: false,
      kestrlTime: 0,
      monsterBanished: false,
      toastTime: 0,
    };

    function resetState() {
      state.lane = 1;
      state.balance = BALANCE_START;
      state.debt = 0;
      state.speed = BASE_SPEED;
      state.monsterDist = MONSTER_MAX_DIST * 0.6;
      state.items = [];
      state.investments = [];
      state.barakahActive = false;
      state.barakahTime = 0;
      state.kestrlActive = false;
      state.kestrlTime = 0;
      state.monsterBanished = false;
      state.toastTime = 0;
      hardMode = false;
    }

    let spawnTimer = 0;

    function startGame(levelName) {
      currentLevel = levelName;
      resetState();
      closeOverlay();
      running = true;
      lastTime = performance.now();
      requestAnimationFrame(loop);
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      state.toastTime = 2.3; // seconds
    }

    function openOverlay(type) {
      running = false;
      overlay.classList.add('active');

      if (type === 'bankrupt') {
        overlayTitle.textContent = 'Bankruptcy';
        overlayText.textContent = 'Your balance hit £0. The Riba Monster is looming over you in the Tunnel of Wants…';
      } else if (type === 'caught') {
        overlayTitle.textContent = 'Caught by Riba';
        overlayText.textContent = 'Debt and shortcuts eventually caught up with you. The Riba Monster closed the gap.';
      } else {
        overlayTitle.textContent = 'Game Over';
        overlayText.textContent = 'Your run in the Tunnel of Wants has ended.';
      }
    }

    function closeOverlay() {
      overlay.classList.remove('active');
    }

    btnRestart.addEventListener('click', () => {
      resetState();
      closeOverlay();
      running = true;
      lastTime = performance.now();
      requestAnimationFrame(loop);
    });

    btnLoan.addEventListener('click', () => {
      // Take a desperate riba loan: more balance, big debt, hard mode
      state.balance += 1000;
      state.debt += 1000;
      hardMode = true;
      state.monsterBanished = false;
      state.kestrlActive = false;
      state.kestrlTime = 0;
      showToast('Riba loan taken. You feel rich… and chained. Interest will chase you hard.');
      closeOverlay();
      running = true;
      lastTime = performance.now();
      requestAnimationFrame(loop);
    });

    // Input
    const keys = {};
    window.addEventListener('keydown', (e) => {
      keys[e.key] = true;

      if (e.key === 'ArrowUp') {
        state.lane = Math.max(0, state.lane - 1);
      } else if (e.key === 'ArrowDown') {
        state.lane = Math.min(LANES - 1, state.lane + 1);
      } else if (e.key === 's' || e.key === 'S') {
        triggerSadaqah();
      } else if (e.key === 'r' || e.key === 'R') {
        resetState();
      } else if (e.key === 'm' || e.key === 'M') {
        // back to map
        showScreen('map');
      }
    });

    window.addEventListener('keyup', (e) => {
      keys[e.key] = false;
    });

    function triggerSadaqah() {
      if (state.balance < SADAQAH_COST) {
        showToast('Not enough balance to give Sadaqah.');
        return;
      }
      state.balance -= SADAQAH_COST;
      state.debt = Math.max(0, state.debt - SADAQAH_DEBT_REDUCTION);
      state.barakahActive = true;
      state.barakahTime = SADAQAH_DURATION;
      showToast('Sadaqah given. Debt eased and barakah activated – halal income feels stronger.');
    }

    function spawnItem(dt) {
      spawnTimer -= dt;
      if (spawnTimer > 0) return;

      // spawn interval gently reduces over time
      const minInterval = 0.45;
      const baseInterval = 0.9;
      spawnTimer = Math.max(minInterval, baseInterval - (state.speed - BASE_SPEED) / 800);

      const lane = Math.floor(Math.random() * LANES);
      const x = WIDTH + 60;

      const roll = Math.random();
      let type;

      if (roll < 0.65) {
        // 65% coins, 80% of those green
        type = Math.random() < 0.8 ? 'green' : 'red';
      } else if (roll < 0.8) {
        type = 'obstacle';
      } else if (roll < 0.9) {
        type = 'invest';
      } else {
        type = 'kestrl';
      }

      // During Kestrl card shield, convert reds to greens
      if (state.kestrlActive && type === 'red') {
        type = 'green';
      }

      state.items.push({ type, lane, x });
    }

    function rectOverlap(x1, y1, w1, h1, x2, y2, w2, h2) {
      return (
        x1 < x2 + w2 &&
        x1 + w1 > x2 &&
        y1 < y2 + h2 &&
        y1 + h1 > y2
      );
    }

    function update(dt) {
      if (!running) return;

      // speed gently ramps
      state.speed += SPEED_INC * dt;

      // money drains
      const livingDrain = BASE_LIVING_COST_PER_SEC * dt;
      const interestPerSec = state.debt * INTEREST_RATE_PER_SEC;
      const interestDrain = interestPerSec * dt;

      state.balance -= livingDrain + interestDrain;
      if (state.balance <= 0) {
        state.balance = 0;
        openOverlay('bankrupt');
        return;
      }

      // investments
      for (let i = state.investments.length - 1; i >= 0; i--) {
        state.investments[i].time -= dt;
        if (state.investments[i].time <= 0) {
          state.balance += INVEST_PAYOFF;
          showToast('Your investment matured – halal profit credited.');
          state.investments.splice(i, 1);
        }
      }

      // barakah timer
      if (state.barakahActive) {
        state.barakahTime -= dt;
        if (state.barakahTime <= 0) {
          state.barakahActive = false;
        }
      }

      // kestrl timer
      if (state.kestrlActive) {
        state.kestrlTime -= dt;
        if (state.kestrlTime <= 0) {
          state.kestrlActive = false;
          state.monsterBanished = false;
        }
      }

      // Monster distance logic
      if (!state.monsterBanished) {
        // Base slow pull
        state.monsterDist -= MONSTER_BASE_PULL_PER_SEC * dt;
        // Interest makes it worse
        state.monsterDist -= (interestPerSec / 20) * dt; // scale down to stay readable
        if (hardMode) {
          state.monsterDist -= MONSTER_EXTRA_PULL_HARD * dt;
        }
        if (state.monsterDist <= MONSTER_MIN_DIST) {
          state.monsterDist = MONSTER_MIN_DIST;
          openOverlay('caught');
          return;
        }
      }

      // move items & collisions
      const playerY = laneYs[state.lane] - PLAYER_H / 2;
      for (let i = state.items.length - 1; i >= 0; i--) {
        const it = state.items[i];
        it.x -= state.speed * dt;

        if (it.x + ITEM_W < -40) {
          state.items.splice(i, 1);
          continue;
        }

        const itemY = laneYs[it.lane] - ITEM_H / 2;
        if (rectOverlap(PLAYER_X, playerY, PLAYER_W, PLAYER_H, it.x, itemY, ITEM_W, ITEM_H)) {
          handleCollision(it.type);
          state.items.splice(i, 1);
        }
      }

      // toast timer
      if (state.toastTime > 0) {
        state.toastTime -= dt;
        if (state.toastTime <= 0) {
          toast.style.display = 'none';
        }
      }

      // spawn
      spawnItem(dt);

      // update HUD
      const interestDisplay = (state.debt * INTEREST_RATE_PER_SEC).toFixed(2);
      hudText.textContent =
        `Balance: £${Math.floor(state.balance)} · Debt: £${Math.floor(state.debt)} · Interest: £${interestDisplay}/sec` +
        (state.barakahActive ? ' · Barakah x2' : '') +
        (state.kestrlActive ? ' · Kestrl Shield' : '') +
        (hardMode ? ' · HARD MODE' : '');
    }

    function handleCollision(type) {
      if (type === 'green') {
        const gain = state.barakahActive ? GREEN_VALUE * 2 : GREEN_VALUE;
        state.balance += gain;
        state.monsterDist = Math.min(MONSTER_MAX_DIST, state.monsterDist + MONSTER_GREEN_PUSH);
      } else if (type === 'red') {
        const gain = state.barakahActive ? RED_VALUE * 2 : RED_VALUE;
        state.balance += gain;
        state.debt += RED_VALUE;
        state.monsterDist = Math.max(MONSTER_MIN_DIST, state.monsterDist - MONSTER_RED_PULL);
        showToast('Quick win from Riba – but your debt and interest just increased.');
      } else if (type === 'obstacle') {
        if (hardMode || !state.kestrlActive) {
          openOverlay('caught');
        } else {
          state.speed = Math.max(BASE_SPEED, state.speed * 0.8);
          showToast('You stumbled, but the Kestrl card shielded you this time.');
        }
      } else if (type === 'invest') {
        if (state.balance < INVEST_COST) {
          showToast('Not enough balance to invest right now.');
        } else {
          state.balance -= INVEST_COST;
          state.investments.push({ time: INVEST_DELAY });
          showToast('You placed a halal investment. Returns will come later, not instantly.');
        }
      } else if (type === 'kestrl') {
        state.kestrlActive = true;
        state.kestrlTime = KESTRL_DURATION;
        state.monsterBanished = true;
        // Purify current reds
        for (const it of state.items) {
          if (it.type === 'red') it.type = 'green';
        }
        showToast('Kestrl mode: Riba Monster banished briefly. Red coins purified to halal.');
      }
    }

    function drawBackground() {
      ctx.fillStyle = '#020617';
      ctx.fillRect(0, 0, WIDTH, HEIGHT);

      // scrolling grid
      const t = performance.now() / 600;
      ctx.strokeStyle = 'rgba(15,118,210,0.4)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      const spacing = 60;
      const offset = (t * state.speed * 0.18) % spacing;
      for (let x = -spacing; x < WIDTH + spacing; x += spacing) {
        ctx.moveTo(x + offset, 0);
        ctx.lineTo(x + offset, HEIGHT);
      }
      ctx.stroke();

      // lane lines
      ctx.strokeStyle = 'rgba(148,163,184,0.35)';
      ctx.beginPath();
      laneYs.forEach(y => {
        ctx.moveTo(0, y + 40);
        ctx.lineTo(WIDTH, y + 40);
      });
      ctx.stroke();
    }

    function drawMonster() {
      const norm = (state.monsterDist - MONSTER_MIN_DIST) / (MONSTER_MAX_DIST - MONSTER_MIN_DIST);
      const x = 60 - (1 - norm) * 40;
      const y = laneYs[state.lane] - MONSTER_H / 2;

      if (state.monsterBanished) {
        ctx.fillStyle = 'rgba(148,163,184,0.25)';
      } else {
        ctx.fillStyle = '#7f1d1d';
      }
      ctx.fillRect(x, y, MONSTER_W, MONSTER_H);

      // Teeth/eyes
      if (!state.monsterBanished) {
        ctx.fillStyle = '#000';
        ctx.fillRect(x + MONSTER_W - 24, y + 18, 14, 14);
        ctx.fillStyle = '#fee2e2';
        ctx.fillRect(x + MONSTER_W - 18, y + 22, 4, 4);
        ctx.fillRect(x + MONSTER_W - 10, y + 22, 4, 4);
      }
    }

    function drawPlayer() {
      const x = PLAYER_X;
      const y = laneYs[state.lane] - PLAYER_H / 2;

      // body
      ctx.fillStyle = '#3b82f6';
      ctx.fillRect(x, y, PLAYER_W, PLAYER_H);

      // wing / cape
      ctx.fillStyle = '#1d4ed8';
      ctx.fillRect(x - 10, y + 8, 10, PLAYER_H - 14);

      // beak
      ctx.fillStyle = '#f59e0b';
      ctx.fillRect(x + PLAYER_W, y + 10, 10, 10);

      // eye
      ctx.fillStyle = '#0f172a';
      ctx.fillRect(x + PLAYER_W - 8, y + 10, 4, 4);
    }

    function drawItems() {
      for (const it of state.items) {
        const x = it.x;
        const y = laneYs[it.lane] - ITEM_H / 2;

        if (it.type === 'green') {
          ctx.fillStyle = '#22c55e';
          ctx.fillRect(x, y, ITEM_W, ITEM_H);
        } else if (it.type === 'red') {
          ctx.fillStyle = '#b91c1c';
          ctx.fillRect(x, y, ITEM_W, ITEM_H);
          ctx.fillStyle = '#fee2e2';
          ctx.fillRect(x + 6, y + 6, 6, 4);
          ctx.fillRect(x + 6, y + 14, 6, 4);
        } else if (it.type === 'obstacle') {
          ctx.fillStyle = '#6b7280';
          ctx.fillRect(x, y, ITEM_W, ITEM_H + 6);
        } else if (it.type === 'invest') {
          ctx.fillStyle = '#facc15';
          ctx.fillRect(x, y, ITEM_W, ITEM_H);
          ctx.fillStyle = '#f97316';
          ctx.fillRect(x + 6, y + 6, ITEM_W - 12, ITEM_H - 12);
        } else if (it.type === 'kestrl') {
          ctx.fillStyle = '#38bdf8';
          ctx.fillRect(x, y, ITEM_W, ITEM_H);
          ctx.fillStyle = '#0ea5e9';
          ctx.fillRect(x + 4, y + 4, ITEM_W - 8, ITEM_H - 8);
        }
      }
    }

    function drawThreatBar() {
      const barX = 32;
      const barY = 24;
      const barW = 260;
      const barH = 22;

      ctx.fillStyle = '#111827';
      ctx.fillRect(barX, barY, barW, barH);

      const norm = 1 - (state.monsterDist - MONSTER_MIN_DIST) / (MONSTER_MAX_DIST - MONSTER_MIN_DIST);
      const w = Math.max(0, Math.min(1, norm)) * barW;

      ctx.fillStyle = state.monsterBanished ? '#22c55e' : '#ef4444';
      ctx.fillRect(barX, barY, w, barH);

      ctx.fillStyle = '#f9fafb';
      ctx.font = '20px system-ui';
      ctx.fillText('£' + Math.floor(state.balance), barX, barY - 6);

      ctx.font = '18px system-ui';
      ctx.fillText('THREAT', barX + barW + 16, barY + barH - 4);
    }

    function draw(dt) {
      drawBackground();
      drawItems();
      drawMonster();
      drawPlayer();
      drawThreatBar();
    }

    function loop(timestamp) {
      if (!running) return;

      if (!lastTime) lastTime = timestamp;
      const dt = (timestamp - lastTime) / 1000;
      lastTime = timestamp;

      update(dt);
      draw(dt);

      requestAnimationFrame(loop);
    }

    // Start on cutscene
    showScreen('cutscene');
  </script>
</body>
</html>

















    


