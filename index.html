<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Riba Run – Cutscene, Map & Minigame</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      height: 100vh;
      background: #020617;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      overflow: hidden;
    }

    /* =========================
       CUTSCENE SCREEN
       ========================= */
    #cutscene-screen {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      z-index: 50;
      flex-direction: column;
    }

    #cutscene-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }

    #cutscene-overlay-bar {
      position: absolute;
      bottom: 16px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      pointer-events: none;
      font-size: 13px;
      color: #e5e7eb;
      text-shadow: 0 0 6px #000;
    }

    #cutscene-hint {
      opacity: 0.9;
    }

    #skip-cutscene {
      pointer-events: auto;
      padding: 8px 14px;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(248,250,252,0.3);
      color: #f9fafb;
      font-size: 13px;
      cursor: pointer;
      backdrop-filter: blur(6px);
    }

    #skip-cutscene:hover {
      background: rgba(15,23,42,1);
    }

    /* =========================
       MAP SCREEN
       ========================= */
    #map-screen {
      height: 100vh;
      display: none; /* shown after cutscene */
      justify-content: center;
      align-items: center;
    }

    .map-container {
      position: relative;
      width: 90vw;
      max-width: 1200px;
      aspect-ratio: 16 / 9;
      overflow: hidden;
      border-radius: 22px;
      box-shadow: 0 0 40px rgba(0,0,0,0.8);
    }

    .map {
      width: 100%;
      height: 100%;
      background-image: url("fantasy-world-map.png");
      background-size: cover;
      background-position: center;
      filter: brightness(1.05) contrast(1.08);
    }

    .area {
      position: absolute;
      width: 70px;
      height: 70px;
      border-radius: 999px;
      cursor: pointer;
      background: radial-gradient(circle, rgba(56,189,248,0.45), rgba(56,189,248,0));
      border: 2px solid rgba(191,219,254,0.95);
      box-shadow:
        0 0 0 0 rgba(56,189,248,0.7),
        0 0 30px rgba(56,189,248,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5f4ff;
      font-weight: 700;
      font-size: 20px;
      text-shadow: 0 0 6px #020617;
      transition:
        transform 0.18s ease-out,
        box-shadow 0.18s ease-out,
        background 0.18s ease-out,
        filter 0.18s ease-out;
      animation: pulse 2.2s infinite;
      z-index: 2;
    }

    @keyframes pulse {
      0% {
        box-shadow:
          0 0 0 0 rgba(56,189,248,0.7),
          0 0 35px rgba(56,189,248,0.3);
      }
      70% {
        box-shadow:
          0 0 0 18px rgba(56,189,248,0),
          0 0 55px rgba(56,189,248,0.6);
      }
      100% {
        box-shadow:
          0 0 0 0 rgba(56,189,248,0),
          0 0 35px rgba(56,189,248,0.3);
      }
    }

    .area:hover {
      transform: scale(1.12) translateY(-2px);
      background: radial-gradient(circle, rgba(56,189,248,0.7), rgba(56,189,248,0));
      box-shadow:
        0 0 0 8px rgba(56,189,248,0.45),
        0 0 60px rgba(56,189,248,1);
      filter: brightness(1.1);
    }

    .area span {
      position: absolute;
      top: 82px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 14px;
      color: #e5e7eb;
      text-shadow: 0 0 6px #020617;
      pointer-events: none;
    }

    .area--castle   { top: 72%; left: 22%; }
    .area--forest   { top: 52%; left: 48%; }
    .area--cave     { top: 40%; left: 78%; }
    .area--villages { top: 76%; left: 69%; }

    /* =========================
       GAME SCREEN
       ========================= */
    #game-screen {
      display: none;
      height: 100vh;
      justify-content: center;
      align-items: center;
      background: #111;
    }

    #game-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      padding-top: 10px;
      box-sizing: border-box;
    }

    canvas {
      border: 2px solid #444;
      image-rendering: pixelated;
      background: #000;
    }

    #hud {
      margin-top: 8px;
      font-size: 14px;
      text-align: center;
      line-height: 1.4;
    }

    #game-over-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    #game-over-box {
      background: #1a1a1a;
      border: 2px solid #555;
      padding: 20px 24px;
      border-radius: 8px;
      text-align: center;
      max-width: 360px;
    }

    #game-over-box h2 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 20px;
    }

    #game-over-box p {
      margin: 4px 0 14px;
      font-size: 14px;
      color: #ddd;
    }

    .btn {
      display: inline-block;
      margin: 4px 6px;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .btn-danger  { background: #c53030; color: #fff; }
    .btn-secondary { background: #2d3748; color: #fff; }

    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      z-index: 20;
    }
  </style>
</head>
<body>

  <!-- ========== CUTSCENE SCREEN ========== -->
  <div id="cutscene-screen">
    <!-- Trailer video, with controls in case autoplay is blocked -->
    <video
      id="cutscene-video"
      src="cutscene.mp4"
      autoplay
      muted
      controls
      playsinline
      poster="fantasy-world-map.png"
    ></video>

    <div id="cutscene-overlay-bar">
      <div id="cutscene-hint">
        If the video doesn’t start, press play or click “Skip” to go to the map.
      </div>
      <button id="skip-cutscene">Skip ▶</button>
    </div>
  </div>

  <!-- ========== MAP SCREEN ========== -->
  <div id="map-screen">
    <div class="map-container">
      <div class="map"></div>

      <div class="area area--castle">
        1
        <span>Castle Hub</span>
      </div>
      <div class="area area--forest">
        2
        <span>Forest Trials</span>
      </div>
      <div class="area area--cave">
        3
        <span>Riba Cave</span>
      </div>
      <div class="area area--villages">
        4
        <span>Market Town</span>
      </div>
    </div>
  </div>

  <!-- ========== GAME SCREEN (Riba Run 2D) ========== -->
  <div id="game-screen">
    <div id="game-wrapper">
      <canvas id="game" width="800" height="450"></canvas>
      <div id="hud">
        <div>
          <strong>Controls:</strong>
          Arrow Up/Down = change lane &nbsp;|&nbsp;
          S = Sadaqah &nbsp;|&nbsp;
          R = Restart
        </div>
        <div id="stats"></div>
        <div style="font-size: 12px; margin-top: 4px; color:#aaa;">
          Riba Run 2D · Kestrel vs Riba Monster · Halal coins (green), Riba coins (red), Kestrl Card (blue), Investment Gate (yellow)
        </div>
      </div>
    </div>

    <div id="game-over-overlay">
      <div id="game-over-box">
        <h2 id="game-over-title">Bankruptcy</h2>
        <p id="game-over-message">
          Your balance hit £0. The Riba Monster is looming over you in the Tunnel of Wants…
        </p>
        <div style="margin-bottom: 8px;">
          <button class="btn btn-secondary" id="btn-restart">Accept Bankruptcy (Restart)</button>
        </div>
        <div>
          <button class="btn btn-danger" id="btn-loan">
            Take Riba Loan (+£1000)
          </button>
        </div>
        <p style="margin-top: 10px; font-size: 11px; color:#f6e05e;">
          Taking the loan doubles your drain rate and glues the Monster to your back. One mistake = permanent death.
        </p>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    /* ========= CUTSCENE → MAP ========= */

    const cutsceneScreen  = document.getElementById('cutscene-screen');
    const cutsceneVideo   = document.getElementById('cutscene-video');
    const skipButton      = document.getElementById('skip-cutscene');
    const mapScreen       = document.getElementById('map-screen');
    const gameScreen      = document.getElementById('game-screen');

    function goToMapScreen() {
      cutsceneVideo.pause();
      cutsceneScreen.style.display = 'none';
      mapScreen.style.display = 'flex';
    }

    // When cutscene ends, go to map
    cutsceneVideo.addEventListener('ended', goToMapScreen);

    // Skip button always works
    skipButton.addEventListener('click', (e) => {
      e.stopPropagation();
      goToMapScreen();
    });

    // If video fails completely, go straight to map
    cutsceneVideo.addEventListener('error', goToMapScreen);

    // If video hasn't started after 6s (e.g. big file / codec issue), show map anyway
    setTimeout(() => {
      const currentTime = cutsceneVideo.currentTime || 0;
      if (currentTime === 0) {
        goToMapScreen();
      }
    }, 6000);

    // ========= MAP → GAME =========
    document.querySelectorAll('.area').forEach(area => {
      area.addEventListener('click', () => {
        mapScreen.style.display = 'none';
        gameScreen.style.display = 'flex';
        startRibaRun();
      });
    });

    /* ========= FULL 2D RIBA RUN GAME (with DEBT + INTEREST) ========= */

    let ribaRunStarted = false;

    function startRibaRun() {
      if (ribaRunStarted) return;
      ribaRunStarted = true;

      (function() {
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        const LOGICAL_WIDTH = 200;
        const LOGICAL_HEIGHT = 112;
        const SCALE = 4;
        canvas.width = LOGICAL_WIDTH * SCALE;
        canvas.height = LOGICAL_HEIGHT * SCALE;

        ctx.imageSmoothingEnabled = false;
        ctx.setTransform(SCALE, 0, 0, SCALE, 0, 0);

        const statsDiv = document.getElementById('stats');
        const overlay = document.getElementById('game-over-overlay');
        const toast = document.getElementById('toast');

        const btnRestart = document.getElementById('btn-restart');
        const btnLoan = document.getElementById('btn-loan');
        const gameOverTitle = document.getElementById('game-over-title');
        const gameOverMessage = document.getElementById('game-over-message');

        const LANES = 3;
        const laneYs = [40, 60, 80];
        const PLAYER_X = 40;
        const PLAYER_W = 10;
        const PLAYER_H = 8;

        const MONSTER_W = 14;
        const MONSTER_H = 12;

        const ITEM_W = 6;
        const ITEM_H = 6;

        const BASE_SPEED = 1.4;
        const SPEED_INC = 0.0001;

        const BALANCE_START = 500;
        const DRAIN_PER_FRAME_BASE = 1;

        const GREEN_VALUE = 10;
        const RED_VALUE   = 50;

        const SADAQAH_COST = 100;
        const SADAQAH_DURATION_FRAMES = 900;

        const KESTRL_DURATION_FRAMES = 600;

        const INVEST_COST = 200;
        const INVEST_PAYOFF = 600;
        const INVEST_DELAY_FRAMES = 600;

        const MONSTER_START_DISTANCE = 120;
        const MONSTER_GAIN_PER_FRAME = 0.05;
        const MONSTER_GREEN_PUSH_BACK = 6;
        const MONSTER_RED_PULL = 10;
        const MONSTER_LOAN_EXTRA_PULL = 0.12;

        const FRAME_TIME = 1000 / 60;

        const INTEREST_RATE_PER_FRAME = 0.00025;

        let playerLane, balance, drainPerFrame;
        let monsterDistance;
        let items;
        let investments;
        let speed;
        let frameCount;
        let barakahActive, barakahTimer;
        let kestrlActive, kestrlTimer;
        let worldBright;
        let monsterBanished;
        let loanTaken;
        let running;
        let lastTime;
        let spawnTimer;
        let toastTimer = 0;
        let gameOver = false;
        let fogLevel = 0.4;

        let debt;
        let lastInterestDrain = 0;

        function resetGame() {
          playerLane = 1;
          balance = BALANCE_START;
          debt = 0;
          drainPerFrame = DRAIN_PER_FRAME_BASE;
          monsterDistance = MONSTER_START_DISTANCE;
          items = [];
          investments = [];
          speed = BASE_SPEED;
          frameCount = 0;
          barakahActive = false;
          barakahTimer = 0;
          kestrlActive = false;
          kestrlTimer = 0;
          worldBright = false;
          monsterBanished = false;
          loanTaken = false;
          running = true;
          lastTime = performance.now();
          spawnTimer = 0;
          toastTimer = 0;
          gameOver = false;
          fogLevel = 0.4;
          lastInterestDrain = 0;
          hideOverlay();
        }

        function showToast(msg) {
          toast.innerText = msg;
          toast.style.display = 'block';
          toastTimer = 120;
        }

        function hideOverlay() {
          overlay.style.display = 'none';
        }

        function showOverlay() {
          overlay.style.display = 'flex';
        }

        function triggerGameOver(reason) {
          running = false;
          gameOver = true;

          if (reason === 'balance') {
            gameOverTitle.innerText = 'Bankruptcy';
            gameOverMessage.innerText =
              'Your balance hit £0. The Riba Monster is looming over you in the Tunnel of Wants…';
          } else if (reason === 'caught') {
            gameOverTitle.innerText = 'Caught by Riba';
            gameOverMessage.innerText =
              'The Riba Monster caught you. The weight of debt finally caught up.';
          } else {
            gameOverTitle.innerText = 'Game Over';
            gameOverMessage.innerText = 'Your run has ended in the Tunnel of Wants.';
          }

          showOverlay();
        }

        function takeLoan() {
          if (!gameOver) return;

          balance += 1000;
          debt += 1000;

          monsterDistance = 25;
          loanTaken = true;
          gameOver = false;
          running = true;
          hideOverlay();

          showToast('You took a big riba loan. Your debt and interest are now much heavier…');
        }

        function restartGame() {
          resetGame();
        }

        btnRestart.addEventListener('click', restartGame);
        btnLoan.addEventListener('click', takeLoan);

        const keys = {};
        window.addEventListener('keydown', (e) => {
          keys[e.key] = true;

          if (e.key === 'ArrowUp') {
            playerLane = Math.max(0, playerLane - 1);
          } else if (e.key === 'ArrowDown') {
            playerLane = Math.min(LANES - 1, playerLane + 1);
          } else if (e.key === 's' || e.key === 'S') {
            activateSadaqah();
          } else if (e.key === 'r' || e.key === 'R') {
            restartGame();
          }
        });
        window.addEventListener('keyup', (e) => {
          keys[e.key] = false;
        });

        function activateSadaqah() {
          if (barakahActive) {
            showToast('Barakah already active.');
            return;
          }
          if (balance < SADAQAH_COST) {
            showToast('Not enough balance for Sadaqah.');
            return;
          }
          balance -= SADAQAH_COST;
          barakahActive = true;
          barakahTimer = SADAQAH_DURATION_FRAMES;
          fogLevel = 0.1;
          showToast('Sadaqah given. Barakah reduces the weight of your burdens.');
        }

        function spawnItem() {
          const lane = Math.floor(Math.random() * LANES);
          const x = LOGICAL_WIDTH + 10;

          const roll = Math.random();
          let type;

          if (roll < 0.55) {
            type = Math.random() < 0.6 ? 'green' : 'red';
          } else if (roll < 0.7) {
            type = 'obstacle';
          } else if (roll < 0.84) {
            type = 'invest';
          } else {
            type = 'kestrl';
          }

          if (kestrlActive && type === 'red') {
            type = 'green';
          }

          items.push({ type, x, lane, w: ITEM_W, h: ITEM_H });
        }

        function update(delta) {
          if (!running) return;

          const frames = delta / FRAME_TIME;
          const effectiveFrames = Math.min(frames, 2);

          for (let i = 0; i < effectiveFrames; i++) {
            logicStep();
          }
        }

        function logicStep() {
          frameCount++;

          let interestDrain = debt * INTEREST_RATE_PER_FRAME;
          if (barakahActive) interestDrain *= 0.6;
          drainPerFrame = DRAIN_PER_FRAME_BASE + interestDrain;
          lastInterestDrain = interestDrain;

          balance -= drainPerFrame;
          if (balance <= 0) {
            balance = 0;
            triggerGameOver('balance');
            return;
          }

          speed += SPEED_INC;
          spawnTimer++;
          const spawnInterval = Math.max(30, 80 - Math.floor(frameCount / 600));
          if (spawnTimer >= spawnInterval) {
            spawnItem();
            spawnTimer = 0;
          }

          if (barakahActive) {
            barakahTimer--;
            if (barakahTimer <= 0) {
              barakahActive = false;
              fogLevel = 0.4;
            }
          }

          if (kestrlActive) {
            kestrlTimer--;
            if (kestrlTimer <= 0) {
              kestrlActive = false;
              worldBright = false;
              monsterBanished = false;
            }
          }

          for (let i = investments.length - 1; i >= 0; i--) {
            investments[i].timer--;
            if (investments[i].timer <= 0) {
              if (!gameOver) balance += INVEST_PAYOFF;
              investments.splice(i, 1);
            }
          }

          if (!monsterBanished) {
            monsterDistance -= MONSTER_GAIN_PER_FRAME;
            if (loanTaken) monsterDistance -= MONSTER_LOAN_EXTRA_PULL;
            if (monsterDistance <= 0) {
              monsterDistance = 0;
              triggerGameOver('caught');
              return;
            }
          }

          for (let i = items.length - 1; i >= 0; i--) {
            const it = items[i];
            it.x -= speed;

            if (it.x < -20) {
              items.splice(i, 1);
              continue;
            }

            const py = laneYs[playerLane] - PLAYER_H / 2;
            const px = PLAYER_X;
            if (rectOverlap(
              px, py, PLAYER_W, PLAYER_H,
              it.x, laneYs[it.lane] - it.h / 2, it.w, it.h
            )) {
              if (it.type === 'green') {
                const realGain = GREEN_VALUE * (barakahActive ? 2 : 1);
                balance += realGain;
                if (!monsterBanished) monsterDistance += MONSTER_GREEN_PUSH_BACK;
                showToast('Halal earnings: clean wealth, no debt added.');
              } else if (it.type === 'red') {
                const realGain = RED_VALUE * (barakahActive ? 2 : 1);
                balance += realGain;
                debt += realGain;
                if (!monsterBanished) monsterDistance -= MONSTER_RED_PULL;
                showToast('Riba taken: your balance went up, but so did your debt.');
              } else if (it.type === 'obstacle') {
                if (!monsterBanished) {
                  triggerGameOver('caught');
                  return;
                }
                speed = Math.max(BASE_SPEED, speed * 0.9);
              } else if (it.type === 'invest') {
                if (balance < INVEST_COST) {
                  showToast('Not enough balance to invest.');
                } else {
                  balance -= INVEST_COST;
                  investments.push({ timer: INVEST_DELAY_FRAMES });
                  showToast('Halal investment made. Return will arrive soon inshaAllah.');
                }
              } else if (it.type === 'kestrl') {
                kestrlActive = true;
                kestrlTimer = KESTRL_DURATION_FRAMES;
                worldBright = true;
                monsterBanished = true;
                for (const other of items) {
                  if (other.type === 'red') other.type = 'green';
                }
                showToast('Kestrl Card: Riba purified, haram coins converted to halal.');
              }

              items.splice(i, 1);
            }
          }

          if (toastTimer > 0) {
            toastTimer--;
            if (toastTimer <= 0) toast.style.display = 'none';
          }
        }

        function rectOverlap(x1,y1,w1,h1,x2,y2,w2,h2) {
          return (
            x1 < x2 + w2 &&
            x1 + w1 > x2 &&
            y1 < y2 + h2 &&
            y1 + h1 > y2
          );
        }

        function drawBackground() {
          const grd = ctx.createLinearGradient(0, 0, 0, LOGICAL_HEIGHT);
          const baseDark = fogLevel;
          grd.addColorStop(0, `rgba(0,0,0,1)`);
          grd.addColorStop(1, `rgba(0,0,0,${1 - baseDark})`);
          ctx.fillStyle = grd;
          ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);

          ctx.strokeStyle = worldBright ? 'rgba(120,255,180,0.4)' : 'rgba(0,255,150,0.25)';
          ctx.lineWidth = 0.5;

          ctx.beginPath();
          for (let x = 0; x < LOGICAL_WIDTH; x += 10) {
            ctx.moveTo(x + (frameCount % 10), 0);
            ctx.lineTo(x + (frameCount % 10), LOGICAL_HEIGHT);
          }
          ctx.stroke();

          ctx.strokeStyle = 'rgba(255,255,255,0.12)';
          ctx.beginPath();
          for (let y of laneYs) {
            ctx.moveTo(0, y + 6);
            ctx.lineTo(LOGICAL_WIDTH, y + 6);
          }
          ctx.stroke();
        }

        function drawMonster() {
          const maxDist = MONSTER_START_DISTANCE;
          const t = Math.max(0, Math.min(1, monsterDistance / maxDist));
          const monsterX = 10 - (1 - t) * 6;
          const monsterY = laneYs[playerLane] - MONSTER_H / 2;

          if (monsterBanished) {
            ctx.fillStyle = 'rgba(255,0,0,0.15)';
          } else {
            const pulse = 0.4 + 0.3 * Math.sin(frameCount * 0.2);
            const alpha = 0.7 + 0.2 * Math.sin(frameCount * 0.4);
            ctx.fillStyle = `rgba(${200 + pulse * 55},0,0,${alpha})`;
          }

          ctx.fillRect(monsterX, monsterY, MONSTER_W, MONSTER_H);

          if (!monsterBanished) {
            ctx.fillStyle = '#fff';
            ctx.fillRect(monsterX + MONSTER_W - 4, monsterY + 2, 3, 2);
            ctx.fillRect(monsterX + MONSTER_W - 4, monsterY + 6, 3, 2);
          }
        }

        function drawPlayer() {
          const px = PLAYER_X;
          const py = laneYs[playerLane] - PLAYER_H / 2;

          ctx.fillStyle = '#3b82f6';
          ctx.fillRect(px, py, PLAYER_W, PLAYER_H);

          ctx.fillStyle = '#fbbf24';
          ctx.fillRect(px + PLAYER_W, py + 2, 3, 3);

          ctx.fillStyle = '#000';
          ctx.fillRect(px + PLAYER_W - 3, py + 2, 1, 1);

          ctx.fillStyle = '#1d4ed8';
          ctx.fillRect(px - 2, py + 2, 2, PLAYER_H - 3);
        }

        function drawItems() {
          for (const it of items) {
            const x = it.x;
            const y = laneYs[it.lane] - it.h / 2;

            if (it.type === 'green') {
              ctx.fillStyle = '#22c55e';
              ctx.fillRect(x, y, it.w, it.h);
            } else if (it.type === 'red') {
              ctx.fillStyle = '#ef4444';
              ctx.fillRect(x, y, it.w, it.h);
            } else if (it.type === 'obstacle') {
              ctx.fillStyle = '#9ca3af';
              ctx.fillRect(x, y, it.w, it.h + 2);
            } else if (it.type === 'invest') {
              ctx.fillStyle = '#facc15';
              ctx.fillRect(x, y - 2, 2, it.h + 4);
              ctx.fillRect(x + it.w - 2, y - 2, 2, it.h + 4);
              ctx.fillRect(x, y - 2, it.w, 2);
            } else if (it.type === 'kestrl') {
              ctx.fillStyle = '#38bdf8';
              ctx.fillRect(x, y, it.w, it.h);
              ctx.fillStyle = '#0ea5e9';
              ctx.fillRect(x + 1, y + 1, it.w - 2, it.h - 2);
            }
          }
        }

        function drawHUD() {
          const barX = 4;
          const barY = 4;

          ctx.fillStyle = '#fff';
          ctx.font = '6px monospace';
          ctx.fillText('£' + Math.max(0, Math.floor(balance)), barX, barY + 6);

          const maxDist = MONSTER_START_DISTANCE;
          const width = 70;
          const t = Math.max(0, Math.min(1, monsterDistance / maxDist));
          const barWidth = width * t;

          ctx.fillStyle = '#4b5563';
          ctx.fillRect(barX, barY + 8, width, 4);

          ctx.fillStyle = monsterBanished ? '#22c55e' : '#ef4444';
          ctx.fillRect(barX, barY + 8, barWidth, 4);

          ctx.fillStyle = '#9ca3af';
          ctx.font = '5px monospace';
          ctx.fillText('THREAT', barX + width + 4, barY + 11);

          const interestPerSecond = lastInterestDrain * 60;
          const statusParts = [];
          if (barakahActive) statusParts.push('Barakah active');
          if (kestrlActive) statusParts.push('Kestrl Mode');
          if (loanTaken) statusParts.push('Big Riba Loan');

          statsDiv.textContent =
            'Balance: £' + Math.max(0, Math.floor(balance)) +
            ' | Debt: £' + Math.floor(debt) +
            ' | Interest: £' + Math.floor(interestPerSecond) + '/sec' +
            (statusParts.length ? ' | ' + statusParts.join(' · ') : '');
        }

        function draw() {
          drawBackground();
          drawItems();
          drawMonster();
          drawPlayer();
          drawHUD();
        }

        function loop(timestamp) {
          if (!lastTime) lastTime = timestamp;
          const delta = timestamp - lastTime;
          lastTime = timestamp;

          update(delta);
          draw();

          requestAnimationFrame(loop);
        }

        let items = [];
        let investments = [];
        resetGame();
        requestAnimationFrame(loop);
      })();
    }
  </script>
</body>
</html>















    


