<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Riba Run – Inflation Survivor (Cutscene, Map & Minigame)</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      background: #020617;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
    }
    body { display: flex; align-items: center; justify-content: center; }
    .screen {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #020617, #020617 30%, #000 70%);
      color: #fff;
    }
    .screen.active { display: flex; }

    /* ---------- CUTSCENE ---------- */
    #cutscene-screen { background: #020617; }
    .hero-root {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
    }
    .hero-bg { position: absolute; inset: 0; z-index: 0; }
    .hero-bg img { width: 100%; height: 100%; object-fit: cover; filter: saturate(1.1); }
    .hero-bg::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(15,23,42,0.15), rgba(15,23,42,0.9));
    }
    .hero-inner {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      width: 100%;
      padding: 32px 24px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 32px;
      align-items: center;
    }
    @media (max-width: 900px) {
      .hero-inner { grid-template-columns: minmax(0, 1fr); gap: 24px; }
    }
    .hero-media {
      margin-inline: auto;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 28px 80px rgba(0,0,0,0.75);
      border: 1px solid rgba(148,163,184,0.7);
      background:#020617;
      width: var(--hero-w, 360px);
      height: var(--hero-h, 220px);
      max-width: min(90vw, 960px);
      max-height: 75vh;
      transition: width 0.15s ease-out, height 0.15s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out;
    }
    .hero-media.expanded {
      box-shadow: 0 40px 120px rgba(15,23,42,1);
      border-color: rgba(56,189,248,0.9);
    }
    .hero-media video { width: 100%; height: 100%; display: block; object-fit: cover; }
    .hero-text { display: flex; flex-direction: column; gap: 12px; max-width: 460px; }
    .hero-kicker {
      font-size: 13px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #93c5fd;
    }
    .hero-title { font-size: clamp(32px, 4vw, 40px); font-weight: 700; line-height: 1.1; }
    .hero-sub { font-size: 14px; color: #d1d5db; }
    .hero-cta-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
    .hero-btn-primary {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #022c22;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(22,163,74,0.75);
      white-space: nowrap;
    }
    .hero-btn-ghost {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.8);
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .hero-scroll-hint { font-size: 12px; color: #9ca3af; margin-top: 4px; }

    /* ---------- MAP ---------- */
    #map-screen { padding: 24px; flex-direction: column; gap: 16px; }
    #map-frame {
      position: relative;
      width: min(1200px, 95vw);
      height: min(700px, calc(100vh - 160px));
      margin: 0 auto;
      border-radius: 22px;
      overflow: hidden;
      background: #020617;
      box-shadow: 0 32px 80px rgba(15,23,42,0.9);
    }
    #world-map { width: 100%; height: 100%; object-fit: contain; display: block; }
    .city-dot {
      position: absolute;
      width: 72px;
      height: 72px;
      border-radius: 999px;
      border: 2px solid rgba(56,189,248,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 30px rgba(56,189,248,0.7);
      background: radial-gradient(circle at center, rgba(56,189,248,0.45), rgba(15,23,42,0.9));
      transform: translate(-50%, -50%);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
    }
    .city-dot:hover {
      transform: translate(-50%, -50%) scale(1.08);
      box-shadow: 0 0 42px rgba(59,130,246,0.95);
      border-color: rgba(59,130,246,1);
    }
    .city-inner {
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(248,250,252,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 20px;
      background: radial-gradient(circle at top, #38bdf8, #0f172a);
      text-shadow: 0 0 6px rgba(15,23,42,0.8);
    }
    .city-label {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translate(-50%, 8px);
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      text-shadow: 0 1px 4px rgba(0,0,0,0.9);
    }
    .city-dot.locked {
      filter: grayscale(100%);
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      border-color: rgba(148,163,184,0.6);
      background: radial-gradient(circle at center, rgba(31,41,55,0.8), rgba(15,23,42,0.95));
    }
    .city-dot.locked:hover { transform: translate(-50%, -50%) scale(1); box-shadow: none; border-color: rgba(148,163,184,0.6); }
    #city-riba-fortress { left: 24%; top: 23%; }
    #city-qard-hasan { left: 36%; top: 55%; }
    #city-sukuk-citadel { left: 24%; top: 79%; }
    #city-inflation { left: 52%; top: 68%; }
    #city-takaful { left: 77%; top: 31%; }
    #city-zakat-coast { left: 77%; top: 70%; }
    #city-market { left: 52%; top: 40%; }
    #map-caption {
      font-size: 14px;
      color: #9ca3af;
      text-align: center;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* ---------- GAME ---------- */
    #game-screen { flex-direction: column; gap: 8px; }
    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      padding-top: 12px;
    }
    canvas#game {
      border-radius: 18px;
      border: 2px solid rgba(15,23,42,0.9);
      background: #000;
      image-rendering: pixelated;
      box-shadow: 0 28px 70px rgba(15,23,42,0.9);
    }
    #hud { margin-top: 10px; font-size: 14px; text-align: center; line-height: 1.4; }
    #hud small { color: #9ca3af; }

    /* ---------- GAME OVER ---------- */
    #game-over-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    #game-over-box {
      background: #020617;
      border-radius: 16px;
      padding: 18px 18px;
      border: 1px solid rgba(148,163,184,0.6);
      width: min(560px, 92vw);
      box-shadow: 0 24px 60px rgba(15,23,42,0.95);
      text-align: left;
    }
    #game-over-box h2 { margin-bottom: 8px; font-size: 20px; }
    #game-over-box p { font-size: 13px; color: #e5e7eb; margin-bottom: 10px; line-height: 1.35; }
    .btnrow { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary { background: #22c55e; color: #022c22; font-weight: 700; }
    .btn-danger { background: #f59e0b; color: #1f1300; font-weight: 800; }
    .btn-secondary { background: #1f2937; color: #e5e7eb; }
    .btn-muted { background: #374151; color: #9ca3af; cursor: not-allowed; }

    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 12px;
      padding: 7px 11px;
      border-radius: 999px;
      display: none;
      z-index: 30;
      border: 1px solid rgba(148,163,184,0.6);
      max-width: min(560px, 92vw);
      text-align: center;
    }
    #route-label { font-weight: 600; margin-top: 4px; }
  </style>
</head>
<body>

  <!-- CUTSCENE -->
  <div id="cutscene-screen" class="screen active">
    <div class="hero-root">
      <div class="hero-bg">
        <img src="background.png" alt="Market Town dusk" />
      </div>
      <div class="hero-inner">
        <div class="hero-media" id="hero-media">
          <video id="cutscene" src="cutscene.mp4" preload="auto" playsinline muted></video>
        </div>
        <div class="hero-text">
          <p class="hero-kicker">Kestrl • Riba Run</p>
          <h1 class="hero-title">Survive inflation. Refuse the trap.</h1>
          <p class="hero-sub">
            Wages feel linear, but costs grow fast. Save under pressure, spot the Sadaqah box,
            and use Kestrl to protect yourself from Riba.
          </p>
          <div class="hero-cta-row">
            <button class="hero-btn-primary" id="hero-play-btn">Play story & enter map</button>
            <button class="hero-btn-ghost" id="hero-skip-btn">Skip straight to map</button>
          </div>
          <p class="hero-scroll-hint">Tip: use your mouse wheel or touchpad to expand the video before you start.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map-screen" class="screen">
    <div id="map-frame">
      <img id="world-map" src="fantasy-world-map.png" alt="World Map" />

      <div id="city-riba-fortress" class="city-dot locked" data-route="Riba Fortress" data-locked="true">
        <div class="city-inner">1</div>
        <div class="city-label">Riba Fortress (Locked)</div>
      </div>
      <div id="city-qard-hasan" class="city-dot locked" data-route="Qard Hasan Hamlet" data-locked="true">
        <div class="city-inner">2</div>
        <div class="city-label">Qard Hasan Hamlet (Locked)</div>
      </div>
      <div id="city-sukuk-citadel" class="city-dot locked" data-route="Sukuk Citadel" data-locked="true">
        <div class="city-inner">3</div>
        <div class="city-label">Sukuk Citadel (Locked)</div>
      </div>
      <div id="city-inflation" class="city-dot locked" data-route="Inflation Quarter" data-locked="true">
        <div class="city-inner">4</div>
        <div class="city-label">Inflation Quarter (Locked)</div>
      </div>
      <div id="city-takaful" class="city-dot locked" data-route="Takaful Heights" data-locked="true">
        <div class="city-inner">5</div>
        <div class="city-label">Takaful Heights (Locked)</div>
      </div>
      <div id="city-zakat-coast" class="city-dot locked" data-route="Zakat Coast" data-locked="true">
        <div class="city-inner">6</div>
        <div class="city-label">Zakat Coast (Locked)</div>
      </div>

      <div id="city-market" class="city-dot" data-route="Marketplace" data-locked="false">
        <div class="city-inner">7</div>
        <div class="city-label">Marketplace</div>
      </div>
    </div>

    <div id="map-caption">
      Start your journey in <strong>Marketplace</strong>.
      The other routes will unlock later inshaAllah.<br/>
      <small>Click <strong>Marketplace</strong> to start the Inflation Survivor run.</small>
    </div>
  </div>

  <!-- GAME -->
  <div id="game-screen" class="screen">
    <div id="game-container">
      <canvas id="game" width="800" height="450"></canvas>
      <div id="hud">
        <div><strong>Controls:</strong> Arrow Up/Down = change lane &nbsp;|&nbsp; S = Save £10 &nbsp;|&nbsp; R = Restart</div>
        <div id="route-label"></div>
        <div id="stats"></div>
        <small>Lane 3 is always the escape route when haram obstacles appear.</small>
      </div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="game-over-overlay">
    <div id="game-over-box">
      <h2 id="game-over-title">Liquidity Crisis</h2>
      <p id="game-over-message">Your cash hit £0. The Riba Banker slides a contract across the desk.</p>

      <div id="autopsy" style="margin-top:10px; padding:10px; border-radius:12px; border:1px solid rgba(148,163,184,0.35); background: rgba(15,23,42,0.5);">
        <div style="font-size:12px; color:#cbd5e1; margin-bottom:6px; font-weight:700;">Financial Autopsy</div>
        <div id="autopsy-lines" style="font-size:12px; color:#e5e7eb; line-height:1.35;"></div>
      </div>

      <div class="btnrow">
        <button class="btn btn-danger" id="btn-loan">The Bridge Loan (+£100)</button>
        <button class="btn btn-primary" id="btn-savings">Use Savings (£150)</button>
        <button class="btn btn-secondary" id="btn-bankrupt">Declare Bankruptcy</button>
      </div>

      <p style="margin-top: 10px; font-size: 11px; color:#fbbf24;">
        Loan hides a cost: burn increases and your controls get heavier.
      </p>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    /* ---------- SCREEN MANAGEMENT + HERO EXPANSION ---------- */
    const cutsceneScreen = document.getElementById('cutscene-screen');
    const mapScreen = document.getElementById('map-screen');
    const gameScreen = document.getElementById('game-screen');
    const cutsceneVideo = document.getElementById('cutscene');
    const routeLabel = document.getElementById('route-label');
    const heroMedia = document.getElementById('hero-media');
    const heroPlayBtn = document.getElementById('hero-play-btn');
    const heroSkipBtn = document.getElementById('hero-skip-btn');

    function showScreen(screen) {
      [cutsceneScreen, mapScreen, gameScreen].forEach(s => s.classList.remove('active'));
      screen.classList.add('active');
    }

    function startMap() {
      showScreen(mapScreen);
      try { cutsceneVideo.pause(); } catch (e) {}
    }

    let heroProgress = 0;
    let heroExpanded = false;

    function updateHeroSize() {
      const minW = 340, maxW = 960;
      const minH = 210, maxH = 540;
      const w = minW + (maxW - minW) * heroProgress;
      const h = minH + (maxH - minH) * heroProgress;
      heroMedia.style.setProperty('--hero-w', w + 'px');
      heroMedia.style.setProperty('--hero-h', h + 'px');
      if (heroProgress >= 1 && !heroExpanded) {
        heroExpanded = true;
        heroMedia.classList.add('expanded');
      }
    }
    updateHeroSize();

    window.addEventListener('wheel', (e) => {
      if (!cutsceneScreen.classList.contains('active')) return;
      if (heroExpanded) return;
      e.preventDefault();
      const delta = e.deltaY * 0.0008;
      heroProgress = Math.min(1, Math.max(0, heroProgress + delta));
      updateHeroSize();
    }, { passive: false });

    heroPlayBtn.addEventListener('click', () => {
      heroProgress = 1;
      heroExpanded = true;
      updateHeroSize();
      cutsceneVideo.currentTime = 0;
      cutsceneVideo.muted = false;
      cutsceneVideo.play().catch(() => {});
    });

    heroSkipBtn.addEventListener('click', startMap);
    cutsceneVideo.addEventListener('ended', startMap);

    /* ---------- MAP CLICK HANDLING ---------- */
    const toast = document.getElementById('toast');
    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      game.toastTimer = 150;
    }

    document.querySelectorAll('.city-dot').forEach(dot => {
      const locked = dot.dataset.locked === 'true';
      if (locked) dot.classList.add('locked');

      dot.addEventListener('click', () => {
        if (dot.dataset.locked === 'true') {
          showToast('This city is locked. Coming soon inshaAllah.');
          return;
        }
        const route = dot.dataset.route || "Unknown Route";
        routeLabel.textContent = "Route: " + route;
        showScreen(gameScreen);
        game.start(route);
      });
    });

    /* ---------- GAME ---------- */
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const LOGICAL_WIDTH = 200;
    const LOGICAL_HEIGHT = 112;
    const SCALE = 4;
    canvas.width = LOGICAL_WIDTH * SCALE;
    canvas.height = LOGICAL_HEIGHT * SCALE;
    ctx.imageSmoothingEnabled = false;
    ctx.setTransform(SCALE, 0, 0, SCALE, 0, 0);

    const statsDiv = document.getElementById('stats');
    const overlay = document.getElementById('game-over-overlay');
    const btnLoan = document.getElementById('btn-loan');
    const btnSavings = document.getElementById('btn-savings');
    const btnBankrupt = document.getElementById('btn-bankrupt');
    const gameOverTitle = document.getElementById('game-over-title');
    const gameOverMessage = document.getElementById('game-over-message');
    const autopsyLines = document.getElementById('autopsy-lines');

    function showOverlay() { overlay.style.display = 'flex'; }
    function hideOverlay() { overlay.style.display = 'none'; }

    const LANES = 3;
    const laneYs = [40, 60, 80];
    const PLAYER_X = 40;

    const FRAME_TIME = 1000 / 60;

    /* ---------- GDD ECONOMY ---------- */
    const START_LIQUIDITY = 100;
    const COIN_VALUE = 2;
    const KESTRL_COIN_VALUE = 5;

    const OBSTACLE_PENALTY = 15;

    const SAVE_STEP = 10;
    const REVIVE_COST = 150;
    const REVIVE_REFILL = 100;

    const LOAN_CASH = 100;
    const LOAN_BURN_MULT = 1.4; // +40%
    const LOAN_LAG_ADD = 0.2;   // +0.2s lag

    /* ---------- SADAQAH BOX ---------- */
    const SADAQAH_COST = 40;
    const SADAQAH_DELAY_1 = 2.0;
    const SADAQAH_DELAY_2 = 1.0;
    const SADAQAH_MAGNET_DURATION = 12.0; // (3 → 15s total after hit)
    const SADAQAH_MAGNET_CAP = 80;        // collect exactly £80 then stop

    /* ---------- KESTRL CARD ---------- */
    const KESTRL_DURATION = 10.0;

    /* ---------- SPAWNS ---------- */
    const COINS_PER_SEC_BASE = 4.0; // at 1.0x speed
    const BASE_SPEED = 1.35;

    /* ---------- MONSTER PRESSURE ---------- */
    const MONSTER_START_DIST = 120;
    const MONSTER_GAIN_PER_SEC = 0.9;
    const MONSTER_GREEN_PUSH = 3.0;
    const MONSTER_RED_PULL = 5.0;
    const MONSTER_LOAN_PULL_PER_SEC = 1.6;

    /* ---------- IMAGES ---------- */
    const bgImg = new Image(); bgImg.src = 'background.png';
    const heroImg = new Image(); heroImg.src = 'kestrlmanframes.png';
    const monsterImg = new Image(); monsterImg.src = 'ribamonster.png';
    const halalCoinImg = new Image(); halalCoinImg.src = 'halalcoin.png';
    const ribaCoinImg = new Image(); ribaCoinImg.src = 'ribacoin.png';

    // Optional if you have these:
    const kestrlCardImg = new Image(); kestrlCardImg.src = 'kestrlcard.png';
    const sadaqahBoxImg = new Image(); sadaqahBoxImg.src = 'sadaqahbox.png';

    // Your real obstacle assets:
    const obsBeerImg = new Image(); obsBeerImg.src = 'beer.png';
    const obsPokerImg = new Image(); obsPokerImg.src = 'poker.png';
    const obsRocketImg = new Image(); obsRocketImg.src = 'rocket.png';
    const obsChemicalDrumImg = new Image(); obsChemicalDrumImg.src = 'chemicaldrum.png';

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function inflationPhase(elapsedSec) {
      if (elapsedSec < 30) return { speedMult: 1.0, burnPerSec: 5 };
      if (elapsedSec < 60) return { speedMult: 1.2, burnPerSec: 7 };
      if (elapsedSec < 90) return { speedMult: 1.4, burnPerSec: 10 };
      if (elapsedSec < 120) return { speedMult: 1.6, burnPerSec: 15 };
      return { speedMult: 1.8, burnPerSec: 22 };
    }

    const game = {
      running: false,
      gameOver: false,

      routeName: "Marketplace",
      lastTime: 0,
      frameCount: 0,

      elapsedSec: 0,
      cash: START_LIQUIDITY,
      savings: 0,

      loanTaken: false,
      burnMult: 1.0,

      baseLagSec: 0.0,
      lagSec: 0.0,
      pendingLane: null,
      laneApplyTimerSec: 0.0,

      playerLane: 1,

      items: [],
      coinSpawnAcc: 0,
      obstacleSpawnAcc: 0,
      specialSpawnAcc: 0,

      kestrlActive: false,
      kestrlTimer: 0,

      sadaqahState: "off", // off | waiting | aura | magnet
      sadaqahTimer: 0,
      magnetEarned: 0,

      monsterDistance: MONSTER_START_DIST,
      monsterBanished: false,

      blurTimer: 0,
      tintGreenTimer: 0,
      shakeTimer: 0,
      glitchTimer: 0,

      wagesEarned: 0,
      burnedToInflation: 0,
      obstacleLoss: 0,
      greenCoinsTaken: 0,
      redCoinsTaken: 0,
      savingsDeposited: 0,
      sadaqahGiven: 0,
      sadaqahReturn: 0,
      kestrlPickups: 0,

      toastTimer: 0,

      start(route) {
        this.routeName = route || "Marketplace";
        this.reset();
        requestAnimationFrame(this.loop.bind(this));
      },

      reset() {
        this.running = true;
        this.gameOver = false;

        this.frameCount = 0;
        this.elapsedSec = 0;

        this.cash = START_LIQUIDITY;
        this.savings = 0;

        this.loanTaken = false;
        this.burnMult = 1.0;

        this.baseLagSec = 0.0;
        this.lagSec = 0.0;
        this.pendingLane = null;
        this.laneApplyTimerSec = 0.0;

        this.playerLane = 1;

        this.items = [];
        this.coinSpawnAcc = 0;
        this.obstacleSpawnAcc = 0;
        this.specialSpawnAcc = 0;

        this.kestrlActive = false;
        this.kestrlTimer = 0;

        this.sadaqahState = "off";
        this.sadaqahTimer = 0;
        this.magnetEarned = 0;

        this.monsterDistance = MONSTER_START_DIST;
        this.monsterBanished = false;

        this.blurTimer = 0;
        this.tintGreenTimer = 0;
        this.shakeTimer = 0;
        this.glitchTimer = 0;

        this.wagesEarned = 0;
        this.burnedToInflation = 0;
        this.obstacleLoss = 0;
        this.greenCoinsTaken = 0;
        this.redCoinsTaken = 0;
        this.savingsDeposited = 0;
        this.sadaqahGiven = 0;
        this.sadaqahReturn = 0;
        this.kestrlPickups = 0;

        this.toastTimer = 0;

        hideOverlay();
        this.lastTime = performance.now();
      },

      loop(timestamp) {
        const deltaMs = timestamp - this.lastTime;
        this.lastTime = timestamp;

        const maxSteps = 2;
        const steps = Math.min(maxSteps, deltaMs / FRAME_TIME);

        if (this.running) {
          for (let i = 0; i < steps; i++) this.logicStep(1 / 60);
          this.draw();
        }

        requestAnimationFrame(this.loop.bind(this));
      },

      currentCoinValue() {
        return this.kestrlActive ? KESTRL_COIN_VALUE : COIN_VALUE;
      },

      currentSpeed() {
        const ph = inflationPhase(this.elapsedSec);
        return BASE_SPEED * ph.speedMult;
      },

      currentBurnPerSec() {
        const ph = inflationPhase(this.elapsedSec);
        return ph.burnPerSec * this.burnMult;
      },

      setLaneWithLag(targetLane) {
        targetLane = clamp(targetLane, 0, LANES - 1);
        const lag = this.lagSec;
        if (lag <= 0) {
          this.playerLane = targetLane;
          return;
        }
        this.pendingLane = targetLane;
        this.laneApplyTimerSec = lag;
      },

      logicStep(dt) {
        this.frameCount++;
        this.elapsedSec += dt;

        if (this.pendingLane !== null) {
          this.laneApplyTimerSec -= dt;
          if (this.laneApplyTimerSec <= 0) {
            this.playerLane = this.pendingLane;
            this.pendingLane = null;
          }
        }

        if (this.blurTimer > 0) this.blurTimer -= dt;
        if (this.tintGreenTimer > 0) this.tintGreenTimer -= dt;
        if (this.shakeTimer > 0) this.shakeTimer -= dt;
        if (this.glitchTimer > 0) this.glitchTimer -= dt;

        if (this.toastTimer > 0) {
          this.toastTimer--;
          if (this.toastTimer <= 0) toast.style.display = 'none';
        }

        if (this.kestrlActive) {
          this.kestrlTimer -= dt;
          if (this.kestrlTimer <= 0) {
            this.kestrlActive = false;
            this.monsterBanished = false;
          }
        }

        if (this.sadaqahState !== "off") {
          this.sadaqahTimer -= dt;

          if (this.sadaqahState === "waiting" && this.sadaqahTimer <= 0) {
            this.sadaqahState = "aura";
            this.sadaqahTimer = SADAQAH_DELAY_2;
            showToast("You feel something... (aura)");
          } else if (this.sadaqahState === "aura" && this.sadaqahTimer <= 0) {
            this.sadaqahState = "magnet";
            this.sadaqahTimer = SADAQAH_MAGNET_DURATION;
            this.magnetEarned = 0;
            showToast("Barakah magnet activated.");
          } else if (this.sadaqahState === "magnet") {
            if (this.sadaqahTimer <= 0 || this.magnetEarned >= SADAQAH_MAGNET_CAP) {
              this.sadaqahState = "off";
              this.sadaqahTimer = 0;
              showToast("Magnet ended.");
            }
          }
        }

        const burn = this.currentBurnPerSec() * dt;
        this.cash -= burn;
        this.burnedToInflation += burn;

        if (!this.monsterBanished) {
          this.monsterDistance -= MONSTER_GAIN_PER_SEC * dt;
          if (this.loanTaken) this.monsterDistance -= MONSTER_LOAN_PULL_PER_SEC * dt;
        }
        this.monsterDistance = clamp(this.monsterDistance, 0, MONSTER_START_DIST);

        if (this.cash <= 0) {
          this.cash = 0;
          this.triggerLiquidityCrisis();
          return;
        }

        if (this.monsterDistance <= 0 && !this.monsterBanished) {
          this.triggerCaught();
          return;
        }

        const ph = inflationPhase(this.elapsedSec);
        const coinsPerSec = COINS_PER_SEC_BASE * ph.speedMult;

        this.coinSpawnAcc += coinsPerSec * dt;
        while (this.coinSpawnAcc >= 1) {
          this.spawnCoin();
          this.coinSpawnAcc -= 1;
        }

        const obstaclePerSec = 0.55 * ph.speedMult;
        this.obstacleSpawnAcc += obstaclePerSec * dt;
        while (this.obstacleSpawnAcc >= 1) {
          this.spawnObstacle();
          this.obstacleSpawnAcc -= 1;
        }

        const specialPerSec = 0.12 * ph.speedMult;
        this.specialSpawnAcc += specialPerSec * dt;
        while (this.specialSpawnAcc >= 1) {
          this.spawnSpecial();
          this.specialSpawnAcc -= 1;
        }

        const speed = this.currentSpeed();

        for (let i = this.items.length - 1; i >= 0; i--) {
          const it = this.items[i];

          if (this.sadaqahState === "magnet" && (it.type === "green" || it.type === "red")) {
            const targetX = PLAYER_X;
            const targetY = laneYs[this.playerLane];
            const dx = (targetX - it.x);
            const dy = (targetY - laneYs[it.lane]);
            it.x += dx * 0.08;
            it.laneFloat = (it.laneFloat ?? laneYs[it.lane]) + dy * 0.08;
          } else {
            it.x -= speed;
            it.laneFloat = null;
          }

          if (it.x < -30) {
            this.items.splice(i, 1);
            continue;
          }

          const py = laneYs[this.playerLane];
          const iy = (it.laneFloat !== null && it.laneFloat !== undefined) ? it.laneFloat : laneYs[it.lane];
          if (this.hit(PLAYER_X, py, 10, 10, it.x, iy)) {
            this.resolveCollision(it);
            this.items.splice(i, 1);
          }
        }
      },

      hit(px, py, pw, ph, ix, iy) {
        const w = 6, h = 6;
        return (
          px < ix + w &&
          px + pw > ix &&
          py - ph / 2 < iy + h / 2 &&
          py + ph / 2 > iy - h / 2
        );
      },

      spawnCoin() {
        const lane = Math.floor(Math.random() * LANES);
        const x = LOGICAL_WIDTH + 10;

        let type = (Math.random() < 0.72) ? "green" : "red";
        if (this.kestrlActive && type === "red") type = "green";

        this.items.push({ type, lane, x });
      },

      spawnObstacle() {
        // Grid rule: obstacles only lanes 0 or 1. lane 2 is escape route.
        const lane = Math.random() < 0.5 ? 0 : 1;
        const x = LOGICAL_WIDTH + 10;

        const r = Math.random();
        let kind;
        if (r < 0.25) kind = "beer";
        else if (r < 0.5) kind = "poker";
        else if (r < 0.75) kind = "rocket";
        else kind = "chemicaldrum";

        this.items.push({ type: "obstacle", kind, lane, x });
      },

      lane2IsClearSoon() {
        // lane 2 = index 1
        for (const it of this.items) {
          if (it.lane === 1 && it.x > LOGICAL_WIDTH - 40) return false;
        }
        return true;
      },

      spawnSpecial() {
        const x = LOGICAL_WIDTH + 10;

        // Sadaqah condition: cash > 50 and lane 2 clear
        if (this.cash > 50 && this.sadaqahState === "off" && this.lane2IsClearSoon() && Math.random() < 0.35) {
          this.items.push({ type: "sadaqah", lane: 1, x });
          return;
        }

        // Kestrl card sometimes
        if (!this.kestrlActive && Math.random() < 0.55) {
          const lane = Math.floor(Math.random() * LANES);
          this.items.push({ type: "kestrl", lane, x });
        }
      },

      resolveCollision(it) {
        if (it.type === "green") {
          const gain = this.currentCoinValue();
          this.cash += gain;
          this.wagesEarned += gain;
          this.greenCoinsTaken++;
          if (!this.monsterBanished) this.monsterDistance += MONSTER_GREEN_PUSH;
          this.monsterDistance = clamp(this.monsterDistance, 0, MONSTER_START_DIST);

          if (this.sadaqahState === "magnet") {
            this.magnetEarned += gain;
            this.sadaqahReturn += gain;
          }
          return;
        }

        if (it.type === "red") {
          const gain = this.currentCoinValue();
          this.cash += gain;
          this.wagesEarned += gain;
          this.redCoinsTaken++;

          if (!this.monsterBanished) this.monsterDistance -= MONSTER_RED_PULL;
          this.monsterDistance = clamp(this.monsterDistance, 0, MONSTER_START_DIST);
          this.glitchTimer = 0.28;
          return;
        }

        if (it.type === "kestrl") {
          this.kestrlActive = true;
          this.kestrlTimer = KESTRL_DURATION;
          this.monsterBanished = true;
          this.kestrlPickups++;

          for (const o of this.items) if (o.type === "red") o.type = "green";

          // Purification: input lag reset to 0.0s immediately (back to base)
          this.lagSec = this.baseLagSec;

          showToast("Kestrl Card: coin value boosted, riba purified, obstacles ghosted.");
          return;
        }

        if (it.type === "sadaqah") {
          if (this.cash < SADAQAH_COST) {
            showToast("You saw Sadaqah, but could not afford it.");
            return;
          }
          this.cash -= SADAQAH_COST;
          this.sadaqahGiven += SADAQAH_COST;

          this.sadaqahState = "waiting";
          this.sadaqahTimer = SADAQAH_DELAY_1;

          showToast("Sadaqah given. Nothing happens at first...");
          return;
        }

        if (it.type === "obstacle") {
          if (this.kestrlActive) {
            // shield: pass through
            this.glitchTimer = 0.12;
            return;
          }

          this.cash -= OBSTACLE_PENALTY;
          this.obstacleLoss += OBSTACLE_PENALTY;

          // Effects matched to your assets
          if (it.kind === "beer") this.blurTimer = 1.4; // Alcohol = blur
          if (it.kind === "poker") {                    // Gambling = random lane switch
            const newLane = Math.floor(Math.random() * LANES);
            this.playerLane = newLane;
            this.glitchTimer = 0.25;
          }
          if (it.kind === "rocket") this.shakeTimer = 0.6; // Arms = shake
          if (it.kind === "chemicaldrum") this.tintGreenTimer = 1.1; // Chemical = sick tint

          showToast("Haram hit: -" + OBSTACLE_PENALTY + " and control disrupted.");

          if (this.cash <= 0) {
            this.cash = 0;
            this.triggerLiquidityCrisis();
          }
          return;
        }
      },

      triggerLiquidityCrisis() {
        this.running = false;
        this.gameOver = true;

        gameOverTitle.textContent = "Liquidity Crisis";
        gameOverMessage.textContent =
          "Your cash hit £0. Inflation did not care how hard you ran. The Riba Banker offers a bridge loan.";

        this.renderAutopsy();

        if (this.savings >= REVIVE_COST) {
          btnSavings.className = "btn btn-primary";
          btnSavings.disabled = false;
          btnSavings.textContent = "Use Savings (£150)";
        } else {
          btnSavings.className = "btn btn-muted";
          btnSavings.disabled = true;
          btnSavings.textContent = "Use Savings (Need £150)";
        }

        showOverlay();
      },

      triggerCaught() {
        this.running = false;
        this.gameOver = true;

        gameOverTitle.textContent = "Caught by Riba";
        gameOverMessage.textContent =
          "Shortcuts looked tempting, but the trap pulled you in. You got caught.";

        this.renderAutopsy();

        if (this.savings >= REVIVE_COST) {
          btnSavings.className = "btn btn-primary";
          btnSavings.disabled = false;
          btnSavings.textContent = "Use Savings (£150)";
        } else {
          btnSavings.className = "btn btn-muted";
          btnSavings.disabled = true;
          btnSavings.textContent = "Use Savings (Need £150)";
        }

        showOverlay();
      },

      renderAutopsy() {
        const mm = Math.floor(this.elapsedSec / 60);
        const ss = Math.floor(this.elapsedSec % 60).toString().padStart(2, "0");

        const wages = Math.floor(this.wagesEarned);
        const infl = Math.floor(this.burnedToInflation);
        const obs = Math.floor(this.obstacleLoss);
        const sav = Math.floor(this.savings);
        const sada = Math.floor(this.sadaqahReturn);

        autopsyLines.innerHTML =
          `SURVIVED: <strong>${mm}m ${ss}s</strong><br>` +
          `Wages earned: <strong>£${wages}</strong><br>` +
          `Lost to inflation: <strong>-£${infl}</strong><br>` +
          `Lost to haram shocks: <strong>-£${obs}</strong><br>` +
          `Savings pot: <strong>£${sav}</strong><br>` +
          `Sadaqah return collected: <strong>£${sada}</strong><br>` +
          `<span style="color:#cbd5e1;">Lesson:</span> You cannot win on salary alone once costs accelerate.`;
      },

      takeLoan() {
        if (!this.gameOver) return;

        this.cash += LOAN_CASH;
        this.loanTaken = true;
        this.burnMult *= LOAN_BURN_MULT;

        this.baseLagSec += LOAN_LAG_ADD;
        this.lagSec = this.baseLagSec;

        this.monsterDistance = Math.min(this.monsterDistance, 35);

        this.running = true;
        this.gameOver = false;
        hideOverlay();
        showToast("Bridge Loan taken. Burn increased. Controls heavier.");
      },

      useSavings() {
        if (!this.gameOver) return;
        if (this.savings < REVIVE_COST) return;

        this.savings -= REVIVE_COST;
        this.cash = REVIVE_REFILL;

        this.running = true;
        this.gameOver = false;
        hideOverlay();
        showToast("Savings used. You are back with full agency.");
      },

      declareBankruptcy() {
        hideOverlay();
        showScreen(mapScreen);
        showToast("You walked away with dignity. Try again when ready.");
      },

      depositSavings() {
        if (!this.running) return;
        if (this.cash < SAVE_STEP) {
          showToast("Not enough cash to save.");
          return;
        }
        this.cash -= SAVE_STEP;
        this.savings += SAVE_STEP;
        this.savingsDeposited += SAVE_STEP;
        showToast("Saved £10 under pressure.");
      },

      drawBackground() {
        if (bgImg.complete && bgImg.naturalWidth) {
          ctx.drawImage(bgImg, 0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
        } else {
          ctx.fillStyle = "#020617";
          ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
        }

        ctx.fillStyle = "rgba(0,0,0,0.22)";
        ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);

        if (this.tintGreenTimer > 0) {
          const a = clamp(this.tintGreenTimer / 1.1, 0, 1) * 0.22;
          ctx.fillStyle = `rgba(34,197,94,${a})`;
          ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
        }

        if (this.blurTimer > 0) {
          const a = clamp(this.blurTimer / 1.4, 0, 1) * 0.18;
          ctx.fillStyle = `rgba(248,250,252,${a})`;
          for (let y = 0; y < LOGICAL_HEIGHT; y += 3) {
            ctx.fillRect(((this.frameCount * 2) % 8), y, LOGICAL_WIDTH, 1);
          }
        }

        if (this.glitchTimer > 0) {
          const a = clamp(this.glitchTimer / 0.28, 0, 1) * 0.18;
          ctx.save();
          ctx.globalAlpha = a;
          ctx.fillStyle = "#ef4444";
          for (let y = 0; y < LOGICAL_HEIGHT; y += 6) {
            ctx.fillRect((this.frameCount * 3) % 12, y, LOGICAL_WIDTH, 2);
          }
          ctx.restore();
        }
      },

      drawMonster() {
        const t = 1 - (this.monsterDistance / MONSTER_START_DIST);
        const x = 10 - t * 8;
        const y = laneYs[this.playerLane];

        let scale = 0.022 + t * 0.02;

        if (monsterImg.complete && monsterImg.naturalWidth) {
          const w = monsterImg.naturalWidth * scale;
          const h = monsterImg.naturalHeight * scale;
          ctx.save();
          if (!this.monsterBanished) {
            ctx.shadowColor = "rgba(239,68,68,0.65)";
            ctx.shadowBlur = 6;
          }
          ctx.drawImage(monsterImg, x - w / 2, y - h / 2, w, h);
          ctx.restore();
        } else {
          ctx.fillStyle = "#7f1d1d";
          ctx.fillRect(x - 6, y - 6, 12, 12);
        }
      },

      drawPlayer() {
        const py = laneYs[this.playerLane];

        if (!heroImg.complete || !heroImg.naturalWidth) {
          ctx.fillStyle = this.kestrlActive ? "#22c55e" : "#3b82f6";
          ctx.fillRect(PLAYER_X - 5, py - 5, 10, 10);
          return;
        }

        const HERO_FRAMES = 5;
        const HERO_FRAME_WIDTH = 390;
        const HERO_FRAME_HEIGHT = 382;
        const HERO_ANIM_SPEED = 10;

        const frameIndex = Math.floor(this.frameCount / HERO_ANIM_SPEED) % HERO_FRAMES;
        const sx = frameIndex * HERO_FRAME_WIDTH;

        const scale = this.kestrlActive ? 0.045 : 0.04;
        const drawW = HERO_FRAME_WIDTH * scale;
        const drawH = HERO_FRAME_HEIGHT * scale;

        const dx = PLAYER_X - drawW / 2;
        const dy = py - drawH / 2;

        ctx.save();
        if (this.kestrlActive) { ctx.shadowColor = "#38bdf8"; ctx.shadowBlur = 6; }
        if (this.sadaqahState === "aura") { ctx.shadowColor = "#fbbf24"; ctx.shadowBlur = 5; }
        ctx.drawImage(heroImg, sx, 0, HERO_FRAME_WIDTH, HERO_FRAME_HEIGHT, dx, dy, drawW, drawH);
        ctx.restore();
      },

      drawItems() {
        for (const it of this.items) {
          const x = it.x;
          const y = (it.laneFloat !== null && it.laneFloat !== undefined) ? it.laneFloat : laneYs[it.lane];

          if (it.type === "green") {
            if (halalCoinImg.complete && halalCoinImg.naturalWidth) {
              const sc = 0.03;
              const w = halalCoinImg.naturalWidth * sc;
              const h = halalCoinImg.naturalHeight * sc;
              ctx.save();
              ctx.shadowColor = "#bbf7d0";
              ctx.shadowBlur = 4;
              ctx.drawImage(halalCoinImg, x - w/2, y - h/2, w, h);
              ctx.restore();
            } else {
              ctx.save();
              ctx.fillStyle = "#22c55e";
              ctx.shadowColor = "#bbf7d0";
              ctx.shadowBlur = 4;
              ctx.fillRect(x - 3, y - 3, 6, 6);
              ctx.restore();
            }
          }

          if (it.type === "red") {
            if (ribaCoinImg.complete && ribaCoinImg.naturalWidth) {
              const sc = 0.03;
              const w = ribaCoinImg.naturalWidth * sc;
              const h = ribaCoinImg.naturalHeight * sc;
              ctx.save();
              ctx.shadowColor = "#fecaca";
              ctx.shadowBlur = 4;
              ctx.drawImage(ribaCoinImg, x - w/2, y - h/2, w, h);
              ctx.restore();
            } else {
              ctx.save();
              ctx.fillStyle = "#ef4444";
              ctx.shadowColor = "#fecaca";
              ctx.shadowBlur = 4;
              ctx.fillRect(x - 3, y - 3, 6, 6);
              ctx.restore();
            }
          }

          if (it.type === "kestrl") {
            if (kestrlCardImg.complete && kestrlCardImg.naturalWidth) {
              const sc = 0.03;
              const w = kestrlCardImg.naturalWidth * sc;
              const h = kestrlCardImg.naturalHeight * sc;
              ctx.save();
              ctx.shadowColor = "#bae6fd";
              ctx.shadowBlur = 5;
              ctx.drawImage(kestrlCardImg, x - w/2, y - h/2, w, h);
              ctx.restore();
            } else {
              ctx.save();
              ctx.fillStyle = "#38bdf8";
              ctx.shadowColor = "#bae6fd";
              ctx.shadowBlur = 6;
              ctx.fillRect(x - 4, y - 4, 8, 8);
              ctx.restore();
            }
          }

          if (it.type === "sadaqah") {
            if (sadaqahBoxImg.complete && sadaqahBoxImg.naturalWidth) {
              const sc = 0.035;
              const w = sadaqahBoxImg.naturalWidth * sc;
              const h = sadaqahBoxImg.naturalHeight * sc;
              ctx.save();
              ctx.shadowColor = "#fbbf24";
              ctx.shadowBlur = 6;
              ctx.drawImage(sadaqahBoxImg, x - w/2, y - h/2, w, h);
              ctx.restore();
            } else {
              ctx.save();
              ctx.fillStyle = "#fbbf24";
              ctx.shadowColor = "#fbbf24";
              ctx.shadowBlur = 6;
              ctx.fillRect(x - 4, y - 4, 8, 8);
              ctx.restore();
            }
          }

          if (it.type === "obstacle") {
            let img = null;
            if (it.kind === "beer") img = obsBeerImg;
            if (it.kind === "poker") img = obsPokerImg;
            if (it.kind === "rocket") img = obsRocketImg;
            if (it.kind === "chemicaldrum") img = obsChemicalDrumImg;

            if (img && img.complete && img.naturalWidth) {
              const sc = 0.03;
              const w = img.naturalWidth * sc;
              const h = img.naturalHeight * sc;

              ctx.save();
              if (!this.kestrlActive) {
                ctx.shadowColor = "rgba(239,68,68,0.55)";
                ctx.shadowBlur = 4;
              } else {
                ctx.globalAlpha = 0.5; // ghosted
              }
              ctx.drawImage(img, x - w/2, y - h/2, w, h);
              ctx.restore();
            } else {
              ctx.save();
              ctx.fillStyle = "#9ca3af";
              ctx.fillRect(x - 4, y - 6, 8, 12);
              ctx.restore();
            }
          }
        }
      },

      drawHUD() {
        if (this.shakeTimer > 0) {
          const mag = 1.2;
          ctx.save();
          ctx.translate((Math.random() - 0.5) * mag, (Math.random() - 0.5) * mag);
        }

        ctx.fillStyle = "#f9fafb";
        ctx.font = "6px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
        const mm = Math.floor(this.elapsedSec / 60);
        const ss = Math.floor(this.elapsedSec % 60).toString().padStart(2, "0");
        ctx.fillText(`£${Math.floor(this.cash)}  |  SAV £${Math.floor(this.savings)}  |  ${mm}:${ss}`, 4, 8);

        const barX = 4, barY = 12, width = 70;
        const t = clamp(this.monsterDistance / MONSTER_START_DIST, 0, 1);
        ctx.fillStyle = "#4b5563";
        ctx.fillRect(barX, barY, width, 4);
        ctx.fillStyle = this.monsterBanished ? "#22c55e" : "#ef4444";
        ctx.fillRect(barX, barY, width * t, 4);
        ctx.fillStyle = "#e5e7eb";
        ctx.font = "5px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
        ctx.fillText("THREAT", barX + width + 4, barY + 4);

        const st = [];
        if (this.kestrlActive) st.push("KESTRL");
        if (this.sadaqahState === "waiting") st.push("SADAQAH... (wait)");
        if (this.sadaqahState === "aura") st.push("AURA");
        if (this.sadaqahState === "magnet") st.push("MAGNET");
        if (this.loanTaken) st.push("LOAN");
        if (this.lagSec > 0) st.push(`LAG ${this.lagSec.toFixed(1)}s`);

        ctx.fillStyle = "#cbd5e1";
        ctx.font = "5px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
        ctx.fillText(st.join(" · "), 4, 24);

        if (this.shakeTimer > 0) ctx.restore();

        const burn = this.currentBurnPerSec();
        const ph = inflationPhase(this.elapsedSec);
        statsDiv.textContent =
          `Cash: £${Math.floor(this.cash)} | Savings: £${Math.floor(this.savings)} | Burn: -£${burn.toFixed(1)}/sec | Speed: ${ph.speedMult.toFixed(1)}x | Coin: £${this.currentCoinValue()}`;
      },

      draw() {
        this.drawBackground();
        this.drawItems();
        this.drawMonster();
        this.drawPlayer();
        this.drawHUD();
      }
    };

    /* ---------- INPUT ---------- */
    window.addEventListener('keydown', e => {
      if (!gameScreen.classList.contains('active')) return;

      if (e.key === 'ArrowUp') {
        game.setLaneWithLag(game.playerLane - 1);
      } else if (e.key === 'ArrowDown') {
        game.setLaneWithLag(game.playerLane + 1);
      } else if (e.key === 's' || e.key === 'S') {
        game.depositSavings();
      } else if (e.key === 'r' || e.key === 'R') {
        game.reset();
      }
    });

    btnLoan.addEventListener('click', () => game.takeLoan());
    btnSavings.addEventListener('click', () => game.useSavings());
    btnBankrupt.addEventListener('click', () => game.declareBankruptcy());
  </script>
</body>
</html>






    


