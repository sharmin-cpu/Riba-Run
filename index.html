<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Riba Run – Cutscene, Map & Minigame</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      background: #020617;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .screen {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #020617, #020617 30%, #000 70%);
      color: #fff;
    }
    .screen.active { display: flex; }

    /* ---------- HERO / CUTSCENE UI (Scroll-expand style) ---------- */
    #cutscene-screen {
      background: #020617;
    }
    .hero-root {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
    }
    .hero-bg {
      position: absolute;
      inset: 0;
      z-index: 0;
    }
    .hero-bg img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.1);
    }
    .hero-bg::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at center, rgba(15,23,42,0.15), rgba(15,23,42,0.9));
    }
    .hero-inner {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      width: 100%;
      padding: 32px 24px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 32px;
      align-items: center;
    }
    @media (max-width: 900px) {
      .hero-inner {
        grid-template-columns: minmax(0, 1fr);
        gap: 24px;
      }
    }
    .hero-media {
      margin-inline: auto;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 28px 80px rgba(0,0,0,0.75);
      border: 1px solid rgba(148,163,184,0.7);
      background:#020617;
      width: var(--hero-w, 360px);
      height: var(--hero-h, 220px);
      max-width: min(90vw, 960px);
      max-height: 75vh;
      transition:
        width 0.15s ease-out,
        height 0.15s ease-out,
        box-shadow 0.2s ease-out,
        border-color 0.2s ease-out;
    }
    .hero-media.expanded {
      box-shadow: 0 40px 120px rgba(15,23,42,1);
      border-color: rgba(56,189,248,0.9);
    }
    .hero-media video {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }

    .hero-text {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 460px;
    }
    .hero-kicker {
      font-size: 13px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #93c5fd;
    }
    .hero-title {
      font-size: clamp(32px, 4vw, 40px);
      font-weight: 700;
      line-height: 1.1;
    }
    .hero-sub {
      font-size: 14px;
      color: #d1d5db;
    }
    .hero-cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    .hero-btn-primary {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #022c22;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(22,163,74,0.75);
      white-space: nowrap;
    }
    .hero-btn-ghost {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.8);
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .hero-scroll-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* ---------- MAP ---------- */
    #map-screen {
      padding: 24px;
      flex-direction: column;
      gap: 16px;
    }
    #map-frame {
      position: relative;
      width: min(1100px, 80vw);      /* smaller so you see the corners */
      max-height: 70vh;
      aspect-ratio: 16/9;
      border-radius: 22px;
      overflow: hidden;
      background: #020617;
      box-shadow: 0 32px 80px rgba(15,23,42,0.9);
    }
    #world-map {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .city-dot {
      position: absolute;
      width: 72px;
      height: 72px;
      border-radius: 999px;
      border: 2px solid rgba(56,189,248,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 30px rgba(56,189,248,0.7);
      background: radial-gradient(circle at center, rgba(56,189,248,0.45), rgba(15,23,42,0.9));
      transition: transform 0.2s ease, box-shadow 0.2s ease,
                  border-color 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
    }
    .city-dot:hover {
      transform: translate(-50%, -50%) scale(1.08);
      box-shadow: 0 0 42px rgba(59,130,246,0.95);
      border-color: rgba(59,130,246,1);
    }
    .city-inner {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(248,250,252,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 20px;
      background: radial-gradient(circle at top, #38bdf8, #0f172a);
      text-shadow: 0 0 6px rgba(15,23,42,0.8);
    }
    .city-label {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translate(-50%, 8px);
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      text-shadow: 0 1px 4px rgba(0,0,0,0.9);
    }

    /* Locked cities */
    .city-dot.locked {
      filter: grayscale(100%);
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      border-color: rgba(148,163,184,0.6);
      background: radial-gradient(circle at center, rgba(31,41,55,0.8), rgba(15,23,42,0.95));
    }
    .city-dot.locked:hover {
      transform: translate(-50%, -50%) scale(1);
      box-shadow: none;
      border-color: rgba(148,163,184,0.6);
    }

    /* City positions on the parchment map */
    #city-riba-fort     { left: 21%; top: 18%; transform: translate(-50%, -50%); }
    #city-qard-hamlet   { left: 23%; top: 46%; transform: translate(-50%, -50%); }
    #city-sukuk-citadel { left: 24%; top: 78%; transform: translate(-50%, -50%); }
    #city-inflation     { left: 50%; top: 72%; transform: translate(-50%, -50%); }
    #city-takaful       { left: 77%; top: 30%; transform: translate(-50%, -50%); }
    #city-zakat-coast   { left: 77%; top: 72%; transform: translate(-50%, -50%); }
    #city-market        { left: 50%; top: 46%; transform: translate(-50%, -50%); }

    #map-caption {
      font-size: 14px;
      color: #9ca3af;
      text-align: center;
    }

    /* ---------- GAME ---------- */
    #game-screen {
      flex-direction: column;
      gap: 8px;
    }
    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      padding-top: 12px;
    }
    canvas#game {
      border-radius: 18px;
      border: 2px solid rgba(15,23,42,0.9);
      background: #000;
      image-rendering: pixelated;
      box-shadow: 0 28px 70px rgba(15,23,42,0.9);
    }
    #hud {
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
      line-height: 1.4;
    }
    #hud small { color: #9ca3af; }

    #game-over-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    #game-over-box {
      background: #020617;
      border-radius: 16px;
      padding: 20px 24px;
      border: 1px solid rgba(148,163,184,0.6);
      max-width: 360px;
      box-shadow: 0 24px 60px rgba(15,23,42,0.95);
      text-align: center;
    }
    #game-over-box h2 {
      margin-bottom: 6px;
      font-size: 22px;
    }
    #game-over-box p {
      font-size: 14px;
      color: #e5e7eb;
      margin-bottom: 10px;
    }
    .btn {
      display: inline-block;
      margin: 4px 6px;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .btn-primary { background: #22c55e; color: #022c22; }
    .btn-danger  { background: #ef4444; color: #fee2e2; }
    .btn-secondary { background: #1f2937; color: #e5e7eb; }

    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 12px;
      padding: 7px 11px;
      border-radius: 999px;
      display: none;
      z-index: 30;
      border: 1px solid rgba(148,163,184,0.6);
    }

    #route-label {
      font-weight: 600;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <!-- HERO / CUTSCENE -->
  <div id="cutscene-screen" class="screen active">
    <div class="hero-root">
      <div class="hero-bg">
        <img src="background.png" alt="Market Town dusk" />
      </div>
      <div class="hero-inner">
        <div class="hero-media" id="hero-media">
          <!-- We’ll manually control when the cutscene plays -->
          <video id="cutscene" src="cutscene.mp4" preload="auto" playsinline muted></video>
        </div>
        <div class="hero-text">
          <p class="hero-kicker">Kestrl • Riba Run</p>
          <h1 class="hero-title">Run clean through the Tunnel of Wants.</h1>
          <p class="hero-sub">
            Scroll to expand the story window, then enter Market Town to face the Riba Monster.
            Every choice shows the difference between barakah and riba.
          </p>
          <div class="hero-cta-row">
            <button class="hero-btn-primary" id="hero-play-btn">
              Play story & enter map
            </button>
            <button class="hero-btn-ghost" id="hero-skip-btn">
              Skip straight to map
            </button>
          </div>
          <p class="hero-scroll-hint">
            Tip: use your mouse wheel or touchpad to expand the video before you start.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map-screen" class="screen">
    <div id="map-frame">
      <img id="world-map" src="fantasy-world-map.png" alt="World Map" />

      <!-- 1. Riba Fortress (top-left castle) -->
      <div id="city-riba-fort"
           class="city-dot locked"
           data-route="Riba Fortress"
           data-locked="true">
        <div class="city-inner">1</div>
        <div class="city-label">Riba Fortress (Locked)</div>
      </div>

      <!-- 2. Qard Hasan Hamlet (left mid house) -->
      <div id="city-qard-hamlet"
           class="city-dot locked"
           data-route="Qard Hasan Hamlet"
           data-locked="true">
        <div class="city-inner">2</div>
        <div class="city-label">Qard Hasan Hamlet (Locked)</div>
      </div>

      <!-- 3. Sukuk Citadel (bottom-left castle) -->
      <div id="city-sukuk-citadel"
           class="city-dot locked"
           data-route="Sukuk Citadel"
           data-locked="true">
        <div class="city-inner">3</div>
        <div class="city-label">Sukuk Citadel (Locked)</div>
      </div>

      <!-- 4. Inflation Quarter (central lower town) -->
      <div id="city-inflation"
           class="city-dot locked"
           data-route="Inflation Quarter"
           data-locked="true">
        <div class="city-inner">4</div>
        <div class="city-label">Inflation Quarter (Locked)</div>
      </div>

      <!-- 5. Takaful Heights (top-right masjid) -->
      <div id="city-takaful"
           class="city-dot locked"
           data-route="Takaful Heights"
           data-locked="true">
        <div class="city-inner">5</div>
        <div class="city-label">Takaful Heights (Locked)</div>
      </div>

      <!-- 6. Zakat Coast (bottom-right masjid) -->
      <div id="city-zakat-coast"
           class="city-dot locked"
           data-route="Zakat Coast"
           data-locked="true">
        <div class="city-inner">6</div>
        <div class="city-label">Zakat Coast (Locked)</div>
      </div>

      <!-- 7. Marketplace (central dome – unlocked) -->
      <div id="city-market"
           class="city-dot"
           data-route="Marketplace"
           data-locked="false">
        <div class="city-inner">7</div>
        <div class="city-label">Marketplace</div>
      </div>
    </div>

    <div id="map-caption">
      Start your journey in <strong>Marketplace</strong>.  
      The other routes – Riba Fortress, Qard Hasan Hamlet, Sukuk Citadel,
      Inflation Quarter, Takaful Heights and Zakat Coast – will unlock later inshaAllah.<br/>
      <small>Click <strong>Marketplace</strong> to start Riba Run.</small>
    </div>
  </div>

  <!-- GAME -->
  <div id="game-screen" class="screen">
    <div id="game-container">
      <canvas id="game" width="800" height="450"></canvas>
      <div id="hud">
        <div><strong>Controls:</strong> Arrow Up/Down = change lane &nbsp;|&nbsp; S = Sadaqah &nbsp;|&nbsp; R = Restart</div>
        <div id="route-label"></div>
        <div id="stats"></div>
        <small>
          Riba Run 2D · Kestrel vs Riba Monster · Halal coins (green), Riba coins (red),
          Kestrl Card (blue), Investment Gate (yellow)
        </small>
      </div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="game-over-overlay">
    <div id="game-over-box">
      <h2 id="game-over-title">Bankruptcy</h2>
      <p id="game-over-message">
        Your balance hit £0. The Riba Monster is looming over you in the Tunnel of Wants…
      </p>
      <div style="margin-bottom: 8px;">
        <button class="btn btn-secondary" id="btn-restart">Accept Bankruptcy (Restart)</button>
      </div>
      <div>
        <button class="btn btn-danger" id="btn-loan">
          Take Riba Loan (+£1000)
        </button>
      </div>
      <p style="margin-top: 10px; font-size: 11px; color:#facc15;">
        Taking the loan doubles your drain and pulls the Riba Monster close. One mistake = permanent death.
      </p>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    /* ---------- SCREEN MANAGEMENT + HERO EXPANSION ---------- */
    const cutsceneScreen = document.getElementById('cutscene-screen');
    const mapScreen = document.getElementById('map-screen');
    const gameScreen = document.getElementById('game-screen');
    const cutsceneVideo = document.getElementById('cutscene');
    const routeLabel = document.getElementById('route-label');
    const heroMedia = document.getElementById('hero-media');
    const heroPlayBtn = document.getElementById('hero-play-btn');
    const heroSkipBtn = document.getElementById('hero-skip-btn');

    function showScreen(screen) {
      [cutsceneScreen, mapScreen, gameScreen].forEach(s => s.classList.remove('active'));
      screen.classList.add('active');
    }

    function startMap() {
      showScreen(mapScreen);
      try { cutsceneVideo.pause(); } catch(e) {}
    }

    // Scroll-to-expand behaviour (simplified ScrollExpandMedia feel)
    let heroProgress = 0;   // 0 → 1
    let heroExpanded = false;

    function updateHeroSize() {
      const minW = 340, maxW = 960;
      const minH = 210, maxH = 540;
      const w = minW + (maxW - minW) * heroProgress;
      const h = minH + (maxH - minH) * heroProgress;
      heroMedia.style.setProperty('--hero-w', w + 'px');
      heroMedia.style.setProperty('--hero-h', h + 'px');
      if (heroProgress >= 1 && !heroExpanded) {
        heroExpanded = true;
        heroMedia.classList.add('expanded');
      }
    }
    updateHeroSize();

    window.addEventListener('wheel', (e) => {
      if (!cutsceneScreen.classList.contains('active')) return;
      if (heroExpanded) return;
      e.preventDefault();
      const delta = e.deltaY * 0.0008; // tweak speed here
      heroProgress = Math.min(1, Math.max(0, heroProgress + delta));
      updateHeroSize();
    }, { passive: false });

    heroPlayBtn.addEventListener('click', () => {
      heroProgress = 1;
      heroExpanded = true;
      updateHeroSize();
      cutsceneVideo.currentTime = 0;
      cutsceneVideo.muted = false;
      cutsceneVideo.play().catch(() => {});
    });

    heroSkipBtn.addEventListener('click', startMap);
    cutsceneVideo.addEventListener('ended', startMap);

    /* ---------- MAP CLICK HANDLING ---------- */
    const toast = document.getElementById('toast');
    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      game.toastTimer = 120;
    }

    document.querySelectorAll('.city-dot').forEach(dot => {
      const locked = dot.dataset.locked === 'true';
      if (locked) {
        dot.classList.add('locked');
      }

      dot.addEventListener('click', () => {
        if (dot.dataset.locked === 'true') {
          showToast('This city is locked. Minigame coming soon inshaAllah.');
          return;
        }
        const route = dot.dataset.route || "Unknown Route";
        routeLabel.textContent = "Route: " + route;
        showScreen(gameScreen);
        game.start(route);
      });
    });

    /* ---------- GAME LOGIC ---------- */
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const LOGICAL_WIDTH = 200;
    const LOGICAL_HEIGHT = 112;
    const SCALE = 4;
    canvas.width = LOGICAL_WIDTH * SCALE;
    canvas.height = LOGICAL_HEIGHT * SCALE;
    ctx.imageSmoothingEnabled = false;
    ctx.setTransform(SCALE, 0, 0, SCALE, 0, 0);

    const statsDiv = document.getElementById('stats');
    const overlay = document.getElementById('game-over-overlay');
    const btnRestart = document.getElementById('btn-restart');
    const btnLoan = document.getElementById('btn-loan');
    const gameOverTitle = document.getElementById('game-over-title');
    const gameOverMessage = document.getElementById('game-over-message');

    const LANES = 3;
    const laneYs = [40, 60, 80];
    const PLAYER_X = 40;

    const BASE_SPEED = 1.35;
    const SPEED_INC = 0.00008;

    const BALANCE_START = 500;
    const DRAIN_BASE = 0.30;

    const GREEN_VALUE = 15;
    const RED_VALUE = 50;

    const SADAQAH_COST = 80;
    const SADAQAH_DURATION = 900;

    const KESTRL_DURATION = 600;

    const INVEST_COST = 200;
    const INVEST_PAYOFF = 600;
    const INVEST_DELAY = 600;

    const MONSTER_START_DIST = 120;
    const MONSTER_GAIN = 0.028;
    const MONSTER_GREEN_PUSH = 7;
    const MONSTER_RED_PULL = 12;
    const MONSTER_LOAN_PULL = 0.12;

    const FRAME_TIME = 1000 / 60;

    // Images
    const bgImg = new Image();
    bgImg.src = 'background.png';

    const heroImg = new Image();
    heroImg.src = 'kestrlmanframes.png'; // 5-frame sprite sheet, 1950x382

    const HERO_FRAMES = 5;
    const HERO_FRAME_WIDTH = 390;
    const HERO_FRAME_HEIGHT = 382;
    const HERO_ANIM_SPEED = 10; // ~6 FPS

    const monsterImg = new Image();
    monsterImg.src = 'ribamonster.png';

    const halalCoinImg = new Image();
    halalCoinImg.src = 'halalcoin.png';

    const ribaCoinImg = new Image();
    ribaCoinImg.src = 'ribacoin.png';

    function showOverlay() { overlay.style.display = 'flex'; }
    function hideOverlay() { overlay.style.display = 'none'; }

    const game = {
      running: false,
      routeName: "Castle Hub",
      lastTime: 0,
      frameCount: 0,
      speed: BASE_SPEED,
      spawnTimer: 0,
      items: [],
      investments: [],
      playerLane: 1,
      balance: BALANCE_START,
      debt: 0,
      drainPerFrame: DRAIN_BASE,
      monsterDistance: MONSTER_START_DIST,
      monsterScale: 0.025,
      monsterScaleMin: 0.025,
      monsterScaleMax: 0.025,
      barakahActive: false,
      barakahTimer: 0,
      kestrlActive: false,
      kestrlTimer: 0,
      monsterBanished: false,
      loanTaken: false,
      hardModeLoan: false,
      toastTimer: 0,
      gameOver: false,
      glitchTimer: 0,
      fogLevel: 0.4,

      start(route) {
        this.routeName = route || "Castle Hub";
        this.reset();
        requestAnimationFrame(this.loop.bind(this));
      },

      reset() {
        this.playerLane = 1;
        this.balance = BALANCE_START;
        this.debt = 0;
        this.drainPerFrame = DRAIN_BASE;
        this.monsterDistance = MONSTER_START_DIST;
        this.monsterScale = 0.025;
        this.items = [];
        this.investments = [];
        this.speed = BASE_SPEED;
        this.frameCount = 0;
        this.spawnTimer = 0;
        this.barakahActive = false;
        this.barakahTimer = 0;
        this.kestrlActive = false;
        this.kestrlTimer = 0;
        this.monsterBanished = false;
        this.loanTaken = false;
        this.hardModeLoan = false;
        this.toastTimer = 0;
        this.gameOver = false;
        this.glitchTimer = 0;
        this.fogLevel = 0.2;
        this.running = true;
        this.lastTime = performance.now();
        hideOverlay();
      },

      // UPDATED LOOP: keeps the animation frame alive even when not running
      loop(timestamp) {
        const delta = timestamp - this.lastTime;
        this.lastTime = timestamp;
        const frames = Math.min(2, delta / FRAME_TIME);

        if (this.running) {
          for (let i = 0; i < frames; i++) this.logicStep();
          this.draw();
        }

        requestAnimationFrame(this.loop.bind(this));
      },

      logicStep() {
        if (!this.running) return;
        this.frameCount++;

        this.balance -= this.drainPerFrame;
        if (this.balance <= 0) {
          this.balance = 0;
          this.triggerGameOver('balance');
          return;
        }

        this.speed += SPEED_INC;
        this.spawnTimer++;
        const spawnInterval = Math.max(40, 90 - Math.floor(this.frameCount / 900));
        if (this.spawnTimer >= spawnInterval) {
          this.spawnItem();
          this.spawnTimer = 0;
        }

        if (this.barakahActive) {
          this.barakahTimer--;
          if (this.barakahTimer <= 0) {
            this.barakahActive = false;
          }
        }

        if (this.kestrlActive) {
          this.kestrlTimer--;
          if (this.kestrlTimer <= 0) {
            this.kestrlActive = false;
            this.monsterBanished = false;
          }
        }

        for (let i = this.investments.length - 1; i >= 0; i--) {
          const inv = this.investments[i];
          inv.timer--;
          if (inv.timer <= 0) {
            if (!this.gameOver) this.balance += INVEST_PAYOFF;
            this.investments.splice(i, 1);
          }
        }

        if (!this.monsterBanished) {
          this.monsterDistance -= MONSTER_GAIN;
          if (this.loanTaken) this.monsterDistance -= MONSTER_LOAN_PULL;
          if (this.monsterDistance <= 0) {
            this.monsterDistance = 0;
            this.triggerGameOver('caught');
            return;
          }
        }

        for (let i = this.items.length - 1; i >= 0; i--) {
          const it = this.items[i];
          it.x -= this.speed;
          if (it.x < -20) {
            this.items.splice(i, 1);
            continue;
          }
          const px = PLAYER_X;
          const py = laneYs[this.playerLane];
          if (this.hit(px, py, 10, 10, it.x, laneYs[it.lane])) {
            this.resolveCollision(it);
            this.items.splice(i, 1);
          }
        }

        if (this.glitchTimer > 0) this.glitchTimer--;
        if (this.toastTimer > 0) {
          this.toastTimer--;
          if (this.toastTimer <= 0) toast.style.display = 'none';
        }
      },

      spawnItem() {
        const lane = Math.floor(Math.random() * LANES);
        const x = LOGICAL_WIDTH + 10;
        const roll = Math.random();
        let type;

        if (roll < 0.55) {
          type = Math.random() < 0.65 ? 'green' : 'red';
        } else if (roll < 0.7) {
          type = 'obstacle';
        } else if (roll < 0.84) {
          type = 'invest';
        } else {
          type = 'kestrl';
        }

        if (this.kestrlActive && type === 'red') type = 'green';

        this.items.push({ type, lane, x });
      },

      hit(px, py, pw, ph, ix, iy) {
        const w = 6, h = 6;
        return (
          px < ix + w &&
          px + pw > ix &&
          py - ph / 2 < iy + h / 2 &&
          py + ph / 2 > iy - h / 2
        );
      },

      resolveCollision(it) {
        if (it.type === 'green') {
          const gain = GREEN_VALUE * (this.barakahActive ? 2 : 1);
          this.balance += gain;
          if (!this.monsterBanished) this.monsterDistance += MONSTER_GREEN_PUSH;
        } else if (it.type === 'red') {
          const gain = RED_VALUE * (this.barakahActive ? 2 : 1);
          this.balance += gain;
          if (!this.monsterBanished) {
            this.monsterDistance -= MONSTER_RED_PULL;
            this.glitchTimer = 22;
          }
        } else if (it.type === 'obstacle') {
          if (!this.monsterBanished) {
            this.triggerGameOver('caught');
            return;
          }
          this.speed = Math.max(BASE_SPEED, this.speed * 0.9);
        } else if (it.type === 'invest') {
          if (this.balance < INVEST_COST) {
            showToast('Not enough balance to invest.');
          } else {
            this.balance -= INVEST_COST;
            this.investments.push({ timer: INVEST_DELAY });
            showToast('Investment made. Dividend will arrive soon inshaAllah.');
          }
        } else if (it.type === 'kestrl') {
          this.kestrlActive = true;
          this.kestrlTimer = KESTRL_DURATION;
          this.monsterBanished = true;
          for (const o of this.items) if (o.type === 'red') o.type = 'green';
          showToast('Kestrl Mode: Riba Monster banished, haram coins purified.');
        }
      },

      triggerGameOver(reason) {
        this.running = false;
        this.gameOver = true;

        if (reason === 'balance') {
          gameOverTitle.textContent = 'Bankruptcy';
          gameOverMessage.textContent = 'Your balance hit £0. The Riba Monster closed in as debts piled up.';
        } else if (reason === 'caught') {
          gameOverTitle.textContent = 'Caught by Riba';
          gameOverMessage.textContent = 'Quick shortcuts looked tempting – but the Riba Monster caught you.';
        } else {
          gameOverTitle.textContent = 'Game Over';
          gameOverMessage.textContent = 'Your run has ended.';
        }
        showOverlay();
      },

      takeLoan() {
        if (!this.gameOver) return;
        this.balance += 1000;
        this.debt += 1000;
        this.drainPerFrame = DRAIN_BASE * 2;
        this.monsterDistance = 25;
        this.loanTaken = true;
        this.hardModeLoan = true;
        this.gameOver = false;
        this.running = true;
        hideOverlay();
      },

      // background & drawing functions unchanged
      drawBackground() {
        if (bgImg.complete && bgImg.naturalWidth) {
          ctx.drawImage(bgImg, 0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
        } else {
          ctx.fillStyle = '#020617';
          ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
        }

        ctx.fillStyle = 'rgba(0,0,0,0.25)';
        ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);

        if (this.glitchTimer > 0) {
          const alpha = 0.25 + 0.15 * Math.sin(this.frameCount * 0.7);
          ctx.save();
          ctx.globalAlpha = alpha;
          ctx.fillStyle = '#f97316';
          for (let y = 0; y < LOGICAL_HEIGHT; y += 4) {
            ctx.fillRect((this.frameCount * 3) % 10, y, LOGICAL_WIDTH, 2);
          }
          ctx.restore();
        }
      },

      drawMonster() {
        const maxDist = MONSTER_START_DIST;
        const t = Math.max(0, Math.min(1, this.monsterDistance / maxDist));
        const monsterX = 8 - (1 - t) * 7;
        const monsterY = laneYs[this.playerLane];

        const img = monsterImg;
        if (img.complete && img.naturalWidth) {
          const scale = this.monsterScale;
          const w = img.naturalWidth * scale;
          const h = img.naturalHeight * scale;
          const x = monsterX - w / 2;
          const y = monsterY - h / 2;
          ctx.drawImage(img, x, y, w, h);
        } else {
          ctx.fillStyle = '#7f1d1d';
          ctx.fillRect(monsterX - 6, monsterY - 6, 12, 12);
        }
      },

      drawPlayer() {
        const img = heroImg;
        const py = laneYs[this.playerLane];

        if (!img.complete || !img.naturalWidth) {
          ctx.fillStyle = this.kestrlActive ? '#22c55e' : '#3b82f6';
          ctx.fillRect(PLAYER_X - 5, py - 5, 10, 10);
          return;
        }

        const frameIndex = Math.floor(this.frameCount / HERO_ANIM_SPEED) % HERO_FRAMES;
        const sx = frameIndex * HERO_FRAME_WIDTH;
        const sy = 0;

        const scale = this.kestrlActive ? 0.045 : 0.04;
        const drawW = HERO_FRAME_WIDTH * scale;
        const drawH = HERO_FRAME_HEIGHT * scale;

        const dx = PLAYER_X - drawW / 2;
        const dy = py - drawH / 2;

        ctx.save();
        if (this.kestrlActive) {
          ctx.shadowColor = '#38bdf8';
          ctx.shadowBlur = 5;
        }

        ctx.drawImage(
          img,
          sx, sy,
          HERO_FRAME_WIDTH, HERO_FRAME_HEIGHT,
          dx, dy,
          drawW, drawH
        );

        ctx.restore();
      },

      drawItems() {
        for (const it of this.items) {
          const x = it.x;
          const y = laneYs[it.lane];

          if (it.type === 'green') {
            if (halalCoinImg.complete && halalCoinImg.naturalWidth) {
              const scale = 0.03;
              const w = halalCoinImg.naturalWidth * scale;
              const h = halalCoinImg.naturalHeight * scale;
              ctx.save();
              ctx.shadowColor = '#bbf7d0';
              ctx.shadowBlur = 4;
              ctx.drawImage(halalCoinImg, x - w / 2, y - h / 2, w, h);
              ctx.restore();
            } else {
              ctx.save();
              ctx.fillStyle = '#22c55e';
              ctx.shadowColor = '#bbf7d0';
              ctx.shadowBlur = 4;
              ctx.fillRect(x - 3, y - 3, 6, 6);
              ctx.restore();
            }
          } else if (it.type === 'red') {
            if (ribaCoinImg.complete && ribaCoinImg.naturalWidth) {
              const scale = 0.03;
              const w = ribaCoinImg.naturalWidth * scale;
              const h = ribaCoinImg.naturalHeight * scale;
              ctx.save();
              ctx.shadowColor = '#fecaca';
              ctx.shadowBlur = 4;
              ctx.drawImage(ribaCoinImg, x - w / 2, y - h / 2, w, h);
              ctx.restore();
            } else {
              ctx.save();
              ctx.fillStyle = '#ef4444';
              ctx.shadowColor = '#fecaca';
              ctx.shadowBlur = 4;
              ctx.fillRect(x - 3, y - 3, 6, 6);
              ctx.restore();
            }
          } else if (it.type === 'obstacle') {
            ctx.fillStyle = '#9ca3af';
            ctx.fillRect(x - 3, y - 4, 6, 8);
          } else if (it.type === 'invest') {
            ctx.fillStyle = '#facc15';
            ctx.fillRect(x - 4, y - 5, 2, 10);
            ctx.fillRect(x + 2, y - 5, 2, 10);
            ctx.fillRect(x - 4, y - 5, 8, 2);
          } else if (it.type === 'kestrl') {
            ctx.save();
            ctx.fillStyle = '#38bdf8';
            ctx.shadowColor = '#bae6fd';
            ctx.shadowBlur = 5;
            ctx.fillRect(x - 3, y - 3, 6, 6);
            ctx.restore();
          }
        }
      },

      drawHUD() {
        const barX = 4, barY = 4, width = 75;
        ctx.fillStyle = '#f9fafb';
        ctx.font = '6px monospace';
        ctx.fillText('£' + Math.floor(this.balance), barX, barY + 6);

        const maxDist = MONSTER_START_DIST;
        const t = Math.max(0, Math.min(1, this.monsterDistance / maxDist));
        const barWidth = width * t;
        ctx.fillStyle = '#4b5563';
        ctx.fillRect(barX, barY + 8, width, 4);
        ctx.fillStyle = this.monsterBanished ? '#22c55e' : '#ef4444';
        ctx.fillRect(barX, barY + 8, barWidth, 4);
        ctx.fillStyle = '#e5e7eb';
        ctx.font = '5px monospace';
        ctx.fillText('THREAT', barX + width + 4, barY + 11);

        const status = [];
        if (this.barakahActive) status.push('Barakah x2');
        if (this.kestrlActive) status.push('Kestrl Mode');
        if (this.loanTaken) status.push('Riba Loan Active');

        statsDiv.textContent =
          `Balance: £${Math.floor(this.balance)} | Debt: £${Math.floor(this.debt)} | Interest: £${(this.drainPerFrame - DRAIN_BASE).toFixed(2)}/sec` +
          (status.length ? ' | ' + status.join(' · ') : '');
      },

      draw() {
        this.drawBackground();
        this.drawItems();
        this.drawMonster();
        this.drawPlayer();
        this.drawHUD();
      }
    };

    // Input
    window.addEventListener('keydown', e => {
      if (e.key === 'ArrowUp') {
        game.playerLane = Math.max(0, game.playerLane - 1);
      } else if (e.key === 'ArrowDown') {
        game.playerLane = Math.min(LANES - 1, game.playerLane + 1);
      } else if (e.key === 's' || e.key === 'S') {
        if (game.barakahActive) {
          showToast('Barakah already active.');
        } else if (game.balance < SADAQAH_COST) {
          showToast('Not enough balance for Sadaqah.');
        } else {
          game.balance -= SADAQAH_COST;
          game.barakahActive = true;
          game.barakahTimer = SADAQAH_DURATION;
          showToast('Sadaqah given — hidden Barakah x2 activated.');
        }
      } else if (e.key === 'r' || e.key === 'R') {
        game.reset();
      }
    });

    btnRestart.addEventListener('click', () => game.reset());
    btnLoan.addEventListener('click', () => game.takeLoan());
  </script>
</body>
</html>





    


