<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Riba Run – Cutscene, Map & Minigame</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      width: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Generic screens */
    .screen {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #000 100%);
    }

    .screen.active {
      display: flex;
    }

    /* CUTSCENE */
    #cutscene-screen {
      background: #000;
    }

    #cutscene-wrapper {
      position: relative;
      max-width: 1000px;
      width: 100%;
      aspect-ratio: 16/9;
      overflow: hidden;
      border-radius: 18px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.8);
    }

    #cutscene-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }

    #cutscene-overlay-text {
      position: absolute;
      left: 16px;
      bottom: 16px;
      font-size: 13px;
      color: #e5e7eb;
      text-shadow: 0 0 4px #000;
      background: linear-gradient(to right, rgba(0,0,0,0.7), rgba(0,0,0,0));
      padding: 6px 10px;
      border-radius: 999px;
    }

    #skip-btn {
      position: absolute;
      right: 20px;
      bottom: 20px;
      padding: 8px 18px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at top left, #0ea5e9, #020617);
      color: #e5e7eb;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 40px rgba(15,118,110,0.7);
    }

    #skip-btn span {
      font-size: 12px;
      opacity: 0.85;
    }

    #skip-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 60px rgba(14,165,233,0.9);
    }

    /* MAP SCREEN */
    #map-screen-inner {
      position: relative;
      max-width: 1100px;
      width: 96%;
      aspect-ratio: 16 / 9;
      border-radius: 26px;
      overflow: hidden;
      box-shadow: 0 22px 80px rgba(15,23,42,0.95);
      background: #020617;
    }

    #map-bg {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .city-node {
      position: absolute;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid rgba(96,165,250,0.9);
      background: radial-gradient(circle at 30% 20%, #38bdf8 0%, #0f172a 55%, #020617 100%);
      box-shadow:
        0 0 12px rgba(56,189,248,0.9),
        0 0 40px rgba(8,47,73,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
      font-size: 18px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .city-node:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow:
        0 0 16px rgba(96,165,250,1),
        0 0 60px rgba(8,47,73,1);
      border-color: #e0f2fe;
    }

    .city-label {
      position: absolute;
      width: 120px;
      text-align: center;
      font-size: 13px;
      color: #e5e7eb;
      text-shadow: 0 0 8px rgba(15,23,42,0.9);
    }

    #map-title {
      position: absolute;
      left: 24px;
      top: 18px;
      font-size: 18px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
      text-shadow: 0 0 10px rgba(15,23,42,0.9);
      background: radial-gradient(circle at left, rgba(15,23,42,0.9), transparent);
      padding: 6px 10px;
      border-radius: 999px;
    }

    /* GAME SCREEN & HUD */
    #game-screen {
      flex-direction: column;
      gap: 8px;
    }

    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    canvas {
      border: 2px solid #111827;
      image-rendering: pixelated;
      background: #000;
      border-radius: 10px;
      box-shadow: 0 18px 55px rgba(15,23,42,0.95);
    }

    #hud {
      margin-top: 8px;
      font-size: 14px;
      text-align: center;
      line-height: 1.4;
      color: #e5e7eb;
    }

    #stats {
      margin-top: 4px;
    }

    #hud small {
      color: #9ca3af;
      font-size: 12px;
    }

    /* GAME-OVER OVERLAY */
    #game-over-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    #game-over-box {
      background: #020617;
      border-radius: 14px;
      padding: 20px 24px;
      border: 1px solid #4b5563;
      max-width: 360px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 55px rgba(15,23,42,0.9);
    }

    #game-over-box h2 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 22px;
    }

    #game-over-box p {
      margin: 4px 0 14px;
      font-size: 14px;
      color: #e5e7eb;
    }

    .btn {
      display: inline-block;
      margin: 4px 6px;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: #16a34a;
      color: white;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-secondary {
      background: #1f2937;
      color: white;
    }

    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.95);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      display: none;
      z-index: 30;
      border: 1px solid rgba(148,163,184,0.6);
      color: #e5e7eb;
    }
  </style>
</head>
<body>

  <!-- 1) CUTSCENE SCREEN -->
  <div id="cutscene-screen" class="screen active">
    <div id="cutscene-wrapper">
      <video
        id="cutscene-video"
        src="cutscene.mp4"
        autoplay
        muted
        playsinline
      ></video>

      <div id="cutscene-overlay-text">
        If the video doesn’t start, press play or click “Skip”.
      </div>

      <button id="skip-btn">
        Skip
        <span>▶</span>
      </button>
    </div>
  </div>

  <!-- 2) MAP SCREEN -->
  <div id="map-screen" class="screen">
    <div id="map-screen-inner">
      <img id="map-bg" src="fantasy-world-map.png" alt="Fantasy world map" />
      <div id="map-title">Choose your route</div>

      <!-- Castle Hub -->
      <div
        class="city-node"
        style="left: 20%; top: 72%;"
        data-level="Castle Hub"
      >1</div>
      <div
        class="city-label"
        style="left: 14%; top: 83%;"
      >Castle Hub</div>

      <!-- Forest Trials -->
      <div
        class="city-node"
        style="left: 48%; top: 48%;"
        data-level="Forest Trials"
      >2</div>
      <div
        class="city-label"
        style="left: 42%; top: 59%;"
      >Forest Trials</div>

      <!-- Riba Cave -->
      <div
        class="city-node"
        style="left: 74%; top: 40%;"
        data-level="Riba Cave"
      >3</div>
      <div
        class="city-label"
        style="left: 68%; top: 51%;"
      >Riba Cave</div>

      <!-- Market Town -->
      <div
        class="city-node"
        style="left: 64%; top: 76%;"
        data-level="Market Town"
      >4</div>
      <div
        class="city-label"
        style="left: 59%; top: 87%;"
      >Market Town</div>
    </div>
  </div>

  <!-- 3) GAME SCREEN -->
  <div id="game-screen" class="screen">
    <div id="game-container">
      <canvas id="game" width="800" height="450"></canvas>
      <div id="hud">
        <div>
          <strong>Controls:</strong>
          Arrow Up / Arrow Down = change lane &nbsp;|&nbsp;
          S = Sadaqah &nbsp;|&nbsp;
          R = Restart
        </div>
        <div id="stats"></div>
        <small>
          Riba Run 2D · Kestrel vs Riba Monster ·
          Halal coins (green), Riba coins (red), Kestrl Card (blue), Investment Gate (yellow)
        </small>
      </div>
    </div>
  </div>

  <!-- GAME OVER OVERLAY -->
  <div id="game-over-overlay">
    <div id="game-over-box">
      <h2 id="game-over-title">Bankruptcy</h2>
      <p id="game-over-message">
        Your balance hit £0. The Riba Monster is looming over you in the Tunnel of Wants…
      </p>
      <div style="margin-bottom: 8px;">
        <button class="btn btn-secondary" id="btn-restart">Accept Bankruptcy (Restart)</button>
      </div>
      <div>
        <button class="btn btn-danger" id="btn-loan">Take Riba Loan (+£1000)</button>
      </div>
      <p style="margin-top: 10px; font-size: 11px; color:#facc15;">
        Taking the loan doubles your debt and interest. One mistake = permanent death.
      </p>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- NAVIGATION + GAME LOGIC -->
  <script>
    // ---------- SCREEN NAVIGATION (cutscene -> map -> game) ----------

    const cutsceneScreen = document.getElementById('cutscene-screen');
    const cutsceneVideo  = document.getElementById('cutscene-video');
    const skipBtn        = document.getElementById('skip-btn');
    const mapScreen      = document.getElementById('map-screen');
    const gameScreen     = document.getElementById('game-screen');

    function showScreen(screenEl) {
      [cutsceneScreen, mapScreen, gameScreen].forEach(el => {
        el.classList.remove('active');
      });
      screenEl.classList.add('active');
    }

    function goToMap() {
      showScreen(mapScreen);
      try { cutsceneVideo.pause(); } catch(e) {}
    }

    cutsceneVideo.addEventListener('ended', goToMap);
    skipBtn.addEventListener('click', goToMap);

    // Map city click -> start minigame
    document.querySelectorAll('.city-node').forEach(node => {
      node.addEventListener('click', () => {
        const levelName = node.getAttribute('data-level') || 'Tunnel of Wants';
        showScreen(gameScreen);
        if (window.RibaRun && typeof window.RibaRun.start === 'function') {
          window.RibaRun.start(levelName);
        }
      });
    });

    // ---------- RIBA RUN GAME MODULE (sprites + riba glitch) ----------
    window.RibaRun = (function () {
      const canvas = document.getElementById('game');
      const ctx = canvas.getContext('2d');

      const LOGICAL_WIDTH = 200;
      const LOGICAL_HEIGHT = 112;
      const SCALE = 4;

      canvas.width = LOGICAL_WIDTH * SCALE;
      canvas.height = LOGICAL_HEIGHT * SCALE;

      ctx.imageSmoothingEnabled = false;
      ctx.setTransform(SCALE, 0, 0, SCALE, 0, 0);

      const statsDiv = document.getElementById('stats');
      const overlay = document.getElementById('game-over-overlay');
      const toast = document.getElementById('toast');
      const btnRestart = document.getElementById('btn-restart');
      const btnLoan = document.getElementById('btn-loan');
      const gameOverTitle = document.getElementById('game-over-title');
      const gameOverMessage = document.getElementById('game-over-message');

      // Sprites
      const monsterImg = new Image();
      monsterImg.src = 'ribamonster.png';

      const playerImg = new Image();
      playerImg.src = 'kestrlman.png';

      const playerPowerImg = new Image();
      playerPowerImg.src = 'kestrlpowerup.png';

      const LANES = 3;
      const laneYs = [40, 60, 80];
      const PLAYER_X = 40;
      const PLAYER_W = 16;
      const PLAYER_H = 12;

      const MONSTER_W = 20;
      const MONSTER_H = 18;

      const ITEM_W = 6;
      const ITEM_H = 6;

      const BASE_SPEED = 1.3;
      const SPEED_INC = 0.00005;

      const BALANCE_START = 500;
      const DRAIN_PER_FRAME_BASE = 0.3;

      const GREEN_VALUE = 10;
      const RED_VALUE = 50;

      const SADAQAH_COST = 100;
      const SADAQAH_DURATION_FRAMES = 900;

      const KESTRL_DURATION_FRAMES = 600;

      const INVEST_COST = 200;
      const INVEST_PAYOFF = 600;
      const INVEST_DELAY_FRAMES = 600;

      const MONSTER_START_DISTANCE = 120;
      const MONSTER_GAIN_PER_FRAME = 0.04;
      const MONSTER_GREEN_PUSH_BACK = 5;
      const MONSTER_RED_PULL = 14;
      const MONSTER_LOAN_EXTRA_PULL = 0.12;

      const GLITCH_FRAMES = 10;
      const FRAME_TIME = 1000 / 60;

      let playerLane, balance, drainPerFrame, baseDrainPerFrame;
      let monsterDistance;
      let items;
      let investments;
      let speed;
      let frameCount;
      let barakahActive, barakahTimer;
      let kestrlActive, kestrlTimer;
      let worldBright;
      let monsterBanished;
      let loanTaken;
      let running = false;
      let lastTime;
      let spawnTimer;
      let toastTimer = 0;
      let gameOver = false;
      let hardModeLoan = false;
      let fogLevel = 0.4;
      let glitchFrames = 0;
      let currentLevel = '';

      function resetGame() {
        playerLane = 1;
        balance = BALANCE_START;
        baseDrainPerFrame = DRAIN_PER_FRAME_BASE;
        drainPerFrame = baseDrainPerFrame;
        monsterDistance = MONSTER_START_DISTANCE;
        items = [];
        investments = [];
        speed = BASE_SPEED;
        frameCount = 0;
        barakahActive = false;
        barakahTimer = 0;
        kestrlActive = false;
        kestrlTimer = 0;
        worldBright = false;
        monsterBanished = false;
        loanTaken = false;
        running = false;
        lastTime = performance.now();
        spawnTimer = 0;
        toastTimer = 0;
        gameOver = false;
        hardModeLoan = false;
        fogLevel = 0.4;
        glitchFrames = 0;
        hideOverlay();
      }

      function showToast(msg) {
        toast.innerText = msg;
        toast.style.display = 'block';
        toastTimer = 120;
      }

      function hideOverlay() {
        overlay.style.display = 'none';
      }

      function showOverlay() {
        overlay.style.display = 'flex';
      }

      function triggerGameOver(reason) {
        running = false;
        gameOver = true;

        if (reason === 'balance') {
          gameOverTitle.innerText = 'Bankruptcy';
          gameOverMessage.innerText =
            'Your balance hit £0. The Riba Monster is looming over you in the Tunnel of Wants…';
        } else if (reason === 'caught') {
          gameOverTitle.innerText = 'Caught by Riba';
          gameOverMessage.innerText =
            'The Riba Monster caught you. Even with shortcuts and quick money, you couldn’t escape its grip.';
        } else {
          gameOverTitle.innerText = 'Game Over';
          gameOverMessage.innerText = 'Your run has ended in the Tunnel of Wants.';
        }

        showOverlay();
      }

      function takeLoan() {
        if (!gameOver) return;
        balance += 1000;
        baseDrainPerFrame *= 2;
        drainPerFrame = baseDrainPerFrame;
        monsterDistance = 25;
        loanTaken = true;
        hardModeLoan = true;
        gameOver = false;
        running = true;
        hideOverlay();
      }

      function restartGame() {
        resetGame();
        running = true;
      }

      btnRestart.addEventListener('click', restartGame);
      btnLoan.addEventListener('click', takeLoan);

      // Input
      const keys = {};
      window.addEventListener('keydown', (e) => {
        keys[e.key] = true;
        if (e.key === 'ArrowUp') {
          playerLane = Math.max(0, playerLane - 1);
        } else if (e.key === 'ArrowDown') {
          playerLane = Math.min(LANES - 1, playerLane + 1);
        } else if (e.key === 's' || e.key === 'S') {
          activateSadaqah();
        } else if (e.key === 'r' || e.key === 'R') {
          restartGame();
        }
      });

      window.addEventListener('keyup', (e) => {
        keys[e.key] = false;
      });

      function activateSadaqah() {
        if (barakahActive) {
          showToast('Barakah already active.');
          return;
        }
        if (balance < SADAQAH_COST) {
          showToast('Not enough balance for Sadaqah.');
          return;
        }
        balance -= SADAQAH_COST;
        barakahActive = true;
        barakahTimer = SADAQAH_DURATION_FRAMES;
        fogLevel = 0.1;
        showToast('Sadaqah given. Hidden Barakah activated (2x real earnings).');
      }

      function spawnItem() {
        const lane = Math.floor(Math.random() * LANES);
        const x = LOGICAL_WIDTH + 10;

        const roll = Math.random();
        let type;

        if (roll < 0.55) {
          type = Math.random() < 0.65 ? 'green' : 'red';
        } else if (roll < 0.7) {
          type = 'obstacle';
        } else if (roll < 0.84) {
          type = 'invest';
        } else {
          type = 'kestrl';
        }

        if (kestrlActive && type === 'red') type = 'green';
        items.push({ type, x, lane, w: ITEM_W, h: ITEM_H });
      }

      function update(delta) {
        if (!running) return;

        const frames = delta / FRAME_TIME;
        const effectiveFrames = Math.min(frames, 2);

        for (let i = 0; i < effectiveFrames; i++) {
          logicStep();
        }
      }

      function logicStep() {
        frameCount++;

        balance -= drainPerFrame;
        if (balance <= 0) {
          balance = 0;
          triggerGameOver('balance');
          return;
        }

        speed += SPEED_INC;

        spawnTimer++;
        const spawnInterval = Math.max(35, 95 - Math.floor(frameCount / 600));
        if (spawnTimer >= spawnInterval) {
          spawnItem();
          spawnTimer = 0;
        }

        if (barakahActive) {
          barakahTimer--;
          if (barakahTimer <= 0) {
            barakahActive = false;
            fogLevel = 0.4;
          }
        }

        if (kestrlActive) {
          kestrlTimer--;
          if (kestrlTimer <= 0) {
            kestrlActive = false;
            worldBright = false;
            monsterBanished = false;
          }
        }

        for (let i = investments.length - 1; i >= 0; i--) {
          investments[i].timer--;
          if (investments[i].timer <= 0) {
            if (!gameOver) balance += INVEST_PAYOFF;
            investments.splice(i, 1);
          }
        }

        if (!monsterBanished) {
          monsterDistance -= MONSTER_GAIN_PER_FRAME;
          if (loanTaken) monsterDistance -= MONSTER_LOAN_EXTRA_PULL;
          if (monsterDistance <= 0) {
            monsterDistance = 0;
            triggerGameOver('caught');
            return;
          }
        }

        for (let i = items.length - 1; i >= 0; i--) {
          const it = items[i];
          it.x -= speed;

          if (it.x < -20) {
            items.splice(i, 1);
            continue;
          }

          const py = laneYs[playerLane] - PLAYER_H / 2;
          const px = PLAYER_X;

          if (rectOverlap(
            px, py, PLAYER_W, PLAYER_H,
            it.x, laneYs[it.lane] - it.h / 2, it.w, it.h
          )) {
            if (it.type === 'green') {
              const gain = GREEN_VALUE * (barakahActive ? 2 : 1);
              balance += gain;
              if (!monsterBanished) monsterDistance += MONSTER_GREEN_PUSH_BACK;

            } else if (it.type === 'red') {
              const gain = RED_VALUE * (barakahActive ? 2 : 1);
              balance += gain;
              if (!monsterBanished) monsterDistance -= MONSTER_RED_PULL;
              glitchFrames = GLITCH_FRAMES;

            } else if (it.type === 'obstacle') {
              if (!monsterBanished) {
                triggerGameOver('caught');
                return;
              }
              speed = Math.max(BASE_SPEED, speed * 0.9);

            } else if (it.type === 'invest') {
              if (balance < INVEST_COST) {
                showToast('Not enough balance to invest.');
              } else {
                balance -= INVEST_COST;
                investments.push({ timer: INVEST_DELAY_FRAMES });
                showToast('Investment made. Dividend will arrive soon inshaAllah.');
              }

            } else if (it.type === 'kestrl') {
              kestrlActive = true;
              kestrlTimer = KESTRL_DURATION_FRAMES;
              worldBright = true;
              monsterBanished = true;
              for (const other of items) {
                if (other.type === 'red') other.type = 'green';
              }
              showToast('Kestrl Mode: Pure Finance! Riba Monster banished, haram coins purified.');
            }

            items.splice(i, 1);
          }
        }

        if (toastTimer > 0) {
          toastTimer--;
          if (toastTimer <= 0) toast.style.display = 'none';
        }
      }

      function rectOverlap(x1, y1, w1, h1, x2, y2, w2, h2) {
        return (
          x1 < x2 + w2 &&
          x1 + w1 > x2 &&
          y1 < y2 + h2 &&
          y1 + h1 > y2
        );
      }

      function drawBackground() {
        const grd = ctx.createLinearGradient(0, 0, 0, LOGICAL_HEIGHT);
        grd.addColorStop(0, `rgba(0,0,0,1)`);
        grd.addColorStop(1, `rgba(0,0,0,${1 - fogLevel})`);
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);

        ctx.strokeStyle = worldBright
          ? 'rgba(120,255,180,0.4)'
          : 'rgba(0,255,150,0.25)';
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        for (let x = 0; x < LOGICAL_WIDTH; x += 10) {
          ctx.moveTo(x + (frameCount % 10), 0);
          ctx.lineTo(x + (frameCount % 10), LOGICAL_HEIGHT);
        }
        ctx.stroke();

        ctx.strokeStyle = 'rgba(255,255,255,0.12)';
        ctx.beginPath();
        for (let y of laneYs) {
          ctx.moveTo(0, y + 6);
          ctx.lineTo(LOGICAL_WIDTH, y + 6);
        }
        ctx.stroke();
      }

      function drawMonster() {
        const maxDist = MONSTER_START_DISTANCE;
        const t = Math.max(0, Math.min(1, monsterDistance / maxDist));
        const monsterX = 8 - (1 - t) * 6;
        const monsterY = laneYs[playerLane] - MONSTER_H / 2;

        if (monsterBanished) {
          if (monsterImg.complete) {
            ctx.globalAlpha = 0.2;
            ctx.drawImage(monsterImg, monsterX, monsterY, MONSTER_W, MONSTER_H);
            ctx.globalAlpha = 1;
          } else {
            ctx.fillStyle = 'rgba(255,0,0,0.15)';
            ctx.fillRect(monsterX, monsterY, MONSTER_W, MONSTER_H);
          }
        } else {
          if (monsterImg.complete) {
            ctx.drawImage(monsterImg, monsterX, monsterY, MONSTER_W, MONSTER_H);
          } else {
            ctx.fillStyle = '#7f1d1d';
            ctx.fillRect(monsterX, monsterY, MONSTER_W, MONSTER_H);
          }
        }
      }

      function drawPlayer() {
        const px = PLAYER_X;
        const py = laneYs[playerLane] - PLAYER_H / 2;

        const img = kestrlActive ? playerPowerImg : playerImg;
        if (img.complete) {
          ctx.drawImage(img, px, py, PLAYER_W, PLAYER_H);
        } else {
          ctx.fillStyle = kestrlActive ? '#22c55e' : '#3b82f6';
          ctx.fillRect(px, py, PLAYER_W, PLAYER_H);
        }
      }

      function drawItems() {
        for (const it of items) {
          const x = it.x;
          const y = laneYs[it.lane] - it.h / 2;

          if (it.type === 'green') {
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(x, y, it.w, it.h);
          } else if (it.type === 'red') {
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(x, y, it.w, it.h);
          } else if (it.type === 'obstacle') {
            ctx.fillStyle = '#9ca3af';
            ctx.fillRect(x, y, it.w, it.h + 2);
          } else if (it.type === 'invest') {
            ctx.fillStyle = '#facc15';
            ctx.fillRect(x, y - 2, 2, it.h + 4);
            ctx.fillRect(x + it.w - 2, y - 2, 2, it.h + 4);
            ctx.fillRect(x, y - 2, it.w, 2);
          } else if (it.type === 'kestrl') {
            ctx.fillStyle = '#38bdf8';
            ctx.fillRect(x, y, it.w, it.h);
            ctx.fillStyle = '#0ea5e9';
            ctx.fillRect(x + 1, y + 1, it.w - 2, it.h - 2);
          }
        }
      }

      function drawHUD() {
        const barX = 4;
        const barY = 4;

        ctx.fillStyle = '#fff';
        ctx.font = '6px monospace';
        ctx.fillText('£' + Math.max(0, Math.floor(balance)), barX, barY + 6);

        const maxDist = MONSTER_START_DISTANCE;
        const width = 70;
        const t = Math.max(0, Math.min(1, monsterDistance / maxDist));
        const barWidth = width * t;

        ctx.fillStyle = '#4b5563';
        ctx.fillRect(barX, barY + 8, width, 4);

        ctx.fillStyle = monsterBanished ? '#22c55e' : '#ef4444';
        ctx.fillRect(barX, barY + 8, barWidth, 4);

        ctx.fillStyle = '#9ca3af';
        ctx.font = '5px monospace';
        ctx.fillText('THREAT', barX + width + 4, barY + 11);

        const statusParts = [];
        if (currentLevel) statusParts.push('Route: ' + currentLevel);
        statusParts.push('Balance £' + Math.max(0, Math.floor(balance)));
        statusParts.push('Threat ' + Math.floor((1 - t) * 100) + '%');
        if (barakahActive) statusParts.push('Barakah x2');
        if (kestrlActive) statusParts.push('Kestrl Mode');
        if (loanTaken) statusParts.push('Riba Loan Active');

        statsDiv.textContent = statusParts.join(' · ');
      }

      function draw() {
        drawBackground();
        drawItems();
        drawMonster();
        drawPlayer();
        drawHUD();

        if (glitchFrames > 0) {
          ctx.fillStyle = 'rgba(255,0,0,0.18)';
          ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
          glitchFrames--;
        }
      }

      function loop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const delta = timestamp - lastTime;
        lastTime = timestamp;

        update(delta);
        draw();

        requestAnimationFrame(loop);
      }

      resetGame();
      requestAnimationFrame(loop);

      // public API
      return {
        start(levelName) {
          currentLevel = levelName || 'Tunnel of Wants';
          resetGame();
          running = true;
        }
      };
    })();
  </script>
</body>
</html>














    


